# cake-autortt (Ubuntu/Debian)

## üåê Language / ËØ≠Ë®Ä / Bahasa / –Ø–∑—ã–∫ / Ë®ÄË™û / Ng√¥n ng·ªØ / Dil / ÿßŸÑŸÑÿ∫ÿ©

[English](README.md) | [‰∏≠Êñá](README_zh.md) | [Bahasa Indonesia](README_id.md) | [–†—É—Å—Å–∫–∏–π](README_ru.md) | [Êó•Êú¨Ë™û](README_ja.md) | **Ti·∫øng Vi·ªát** | [T√ºrk√ße](README_tr.md) | [ÿßŸÑÿπÿ±ÿ®Ÿäÿ©](README_ar.md)

---

**T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh tham s·ªë RTT c·ªßa CAKE qdisc d·ª±a tr√™n ƒëi·ªÅu ki·ªán m·∫°ng ƒëo ƒë∆∞·ª£c**

ƒê√¢y l√† **b·∫£n port Ubuntu/Debian** c·ªßa cake-autortt, ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh cho c√°c b·∫£n ph√¢n ph·ªëi Linux ti√™u chu·∫©n s·ª≠ d·ª•ng systemd, qu·∫£n l√Ω g√≥i apt v√† t·ªáp c·∫•u h√¨nh truy·ªÅn th·ªëng thay v√¨ h·ªá th·ªëng UCI c·ªßa OpenWrt.

## üåç T·∫°i sao ƒëi·ªÅu n√†y quan tr·ªçng cho tr·∫£i nghi·ªám internet c·ªßa b·∫°n

H·∫ßu h·∫øt ng∆∞·ªùi d√πng ƒë√£ quen v·ªõi vi·ªác t·∫£i nhanh c√°c trang web ch√≠nh nh∆∞ YouTube, Netflix v√† Google - nh·ªØng trang n√†y s·ª≠ d·ª•ng m·∫°ng ph√¢n ph·ªëi n·ªôi dung (CDN) ƒë·∫∑t m√°y ch·ªß r·∫•t g·∫ßn ng∆∞·ªùi d√πng, th∆∞·ªùng cung c·∫•p th·ªùi gian ph·∫£n h·ªìi d∆∞·ªõi 50-100ms. Tuy nhi√™n, internet r·ªông l·ªõn h∆°n nhi·ªÅu so v·ªõi nh·ªØng n·ªÅn t·∫£ng l·ªõn n√†y.

**Khi b·∫°n duy·ªát c√°c trang web ngo√†i nh·ªØng trang ƒë∆∞·ª£c h·ªó tr·ª£ CDN ch√≠nh, b·∫°n g·∫∑p ph·∫£i m·ªôt th·∫ø gi·ªõi ƒëa d·∫°ng c·ªßa c√°c m√°y ch·ªß:**
- **D·ªãch v·ª• ƒë·ªãa ph∆∞∆°ng/khu v·ª±c**: Doanh nghi·ªáp nh·ªè, trang tin t·ª©c ƒë·ªãa ph∆∞∆°ng, di·ªÖn ƒë√†n c·ªông ƒë·ªìng v√† d·ªãch v·ª• khu v·ª±c th∆∞·ªùng c√≥ m√°y ch·ªß trong qu·ªëc gia ho·∫∑c khu v·ª±c c·ªßa b·∫°n (10-50ms RTT)
- **N·ªôi dung qu·ªëc t·∫ø**: C√°c trang web chuy√™n bi·ªát, t√†i nguy√™n h·ªçc thu·∫≠t, m√°y ch·ªß game v√† d·ªãch v·ª• ng√°ch c√≥ th·ªÉ ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n c√°c l·ª•c ƒë·ªãa kh√°c (100-500ms RTT)
- **C∆° s·ªü h·∫° t·∫ßng t·ª´ xa**: M·ªôt s·ªë d·ªãch v·ª•, ƒë·∫∑c bi·ªát ·ªü c√°c khu v·ª±c ƒëang ph√°t tri·ªÉn ho·∫∑c ·ª©ng d·ª•ng chuy√™n bi·ªát, c√≥ th·ªÉ c√≥ ƒë·ªô tr·ªÖ cao h∆°n ƒë√°ng k·ªÉ

**Tham s·ªë RTT c·ªßa CAKE ki·ªÉm so√°t m·ª©c ƒë·ªô t√≠ch c·ª±c c·ªßa thu·∫≠t to√°n qu·∫£n l√Ω h√†ng ƒë·ª£i ph·∫£n ·ª©ng v·ªõi t·∫Øc ngh·∫Ωn.** Theo m·∫∑c ƒë·ªãnh, CAKE s·ª≠ d·ª•ng gi·∫£ ƒë·ªãnh RTT 100ms, ho·∫°t ƒë·ªông kh√° t·ªët cho l∆∞u l∆∞·ª£ng internet chung. Tuy nhi√™n:

- **C√†i ƒë·∫∑t RTT qu√° th·∫•p**: N·∫øu CAKE nghƒ© RTT m·∫°ng ng·∫Øn h∆°n th·ª±c t·∫ø, n√≥ tr·ªü n√™n qu√° t√≠ch c·ª±c trong vi·ªác lo·∫°i b·ªè g√≥i khi h√†ng ƒë·ª£i t√≠ch t·ª•, c√≥ th·ªÉ gi·∫£m bƒÉng th√¥ng cho c√°c m√°y ch·ªß t·ª´ xa
- **C√†i ƒë·∫∑t RTT qu√° cao**: N·∫øu CAKE nghƒ© RTT m·∫°ng d√†i h∆°n th·ª±c t·∫ø, n√≥ tr·ªü n√™n qu√° b·∫£o th·ªß v√† cho ph√©p h√†ng ƒë·ª£i l·ªõn t√≠ch t·ª•, t·∫°o ra ƒë·ªô tr·ªÖ kh√¥ng c·∫ßn thi·∫øt cho c√°c m√°y ch·ªß g·∫ßn

**V√≠ d·ª• t√°c ƒë·ªông th·ª±c t·∫ø:**
- **Ng∆∞·ªùi d√πng Singapore ‚Üí M√°y ch·ªß ƒê·ª©c**: Kh√¥ng c√≥ ƒëi·ªÅu ch·ªânh RTT, ng∆∞·ªùi d√πng ·ªü Singapore truy c·∫≠p trang web ƒê·ª©c (‚âà180ms RTT) c√≥ th·ªÉ g·∫∑p bƒÉng th√¥ng gi·∫£m do c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh 100ms c·ªßa CAKE g√¢y ra vi·ªác lo·∫°i b·ªè g√≥i s·ªõm
- **V√πng n√¥ng th√¥n M·ªπ ‚Üí M√°y ch·ªß khu v·ª±c**: Ng∆∞·ªùi d√πng ·ªü v√πng n√¥ng th√¥n M·ªπ truy c·∫≠p m√°y ch·ªß khu v·ª±c (‚âà25ms RTT) c√≥ th·ªÉ g·∫∑p ƒë·ªô tr·ªÖ cao h∆°n c·∫ßn thi·∫øt v√¨ c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh 100ms c·ªßa CAKE cho ph√©p h√†ng ƒë·ª£i ph√°t tri·ªÉn nhi·ªÅu h∆°n c·∫ßn thi·∫øt
- **·ª®ng d·ª•ng game/th·ªùi gian th·ª±c**: C√°c ·ª©ng d·ª•ng nh·∫°y c·∫£m v·ªõi c·∫£ ƒë·ªô tr·ªÖ v√† bƒÉng th√¥ng ƒë∆∞·ª£c h∆∞·ªüng l·ª£i ƒë√°ng k·ªÉ t·ª´ vi·ªác ƒëi·ªÅu ch·ªânh RTT ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán m·∫°ng th·ª±c t·∫ø

**C√°ch cake-autortt gi√∫p ƒë·ª°:**
B·∫±ng c√°ch t·ª± ƒë·ªông ƒëo RTT th·ª±c t·∫ø ƒë·∫øn c√°c m√°y ch·ªß b·∫°n ƒëang giao ti·∫øp v√† ƒëi·ªÅu ch·ªânh tham s·ªë CAKE t∆∞∆°ng ·ª©ng, b·∫°n nh·∫≠n ƒë∆∞·ª£c:
- **Ph·∫£n h·ªìi nhanh h∆°n** khi truy c·∫≠p m√°y ch·ªß g·∫ßn (RTT ng·∫Øn h∆°n ‚Üí qu·∫£n l√Ω h√†ng ƒë·ª£i t√≠ch c·ª±c h∆°n)
- **BƒÉng th√¥ng t·ªët h∆°n** khi truy c·∫≠p m√°y ch·ªß t·ª´ xa (RTT d√†i h∆°n ‚Üí qu·∫£n l√Ω h√†ng ƒë·ª£i ki√™n nh·∫´n h∆°n)
- **Ki·ªÉm so√°t bufferbloat t·ªëi ∆∞u** th√≠ch ·ª©ng v·ªõi ƒëi·ªÅu ki·ªán m·∫°ng th·ª±c t·∫ø thay v√¨ gi·∫£ ƒë·ªãnh

ƒêi·ªÅu n√†y ƒë·∫∑c bi·ªát c√≥ gi√° tr·ªã cho ng∆∞·ªùi d√πng th∆∞·ªùng xuy√™n truy c·∫≠p c√°c ngu·ªìn n·ªôi dung ƒëa d·∫°ng, l√†m vi·ªác v·ªõi d·ªãch v·ª• qu·ªëc t·∫ø, ho·∫∑c s·ªëng ·ªü nh·ªØng khu v·ª±c m√† l∆∞u l∆∞·ª£ng internet th∆∞·ªùng ƒëi qua kho·∫£ng c√°ch l·ªõn.

## üöÄ T√≠nh nƒÉng

- **Kh√°m ph√° RTT t·ª± ƒë·ªông**: Gi√°m s√°t k·∫øt n·ªëi ho·∫°t ƒë·ªông qua `/proc/net/nf_conntrack` v√† ƒëo RTT ƒë·∫øn c√°c host b√™n ngo√†i
- **L·ªçc host th√¥ng minh**: T·ª± ƒë·ªông l·ªçc ƒë·ªãa ch·ªâ LAN v√† t·∫≠p trung v√†o c√°c host b√™n ngo√†i
- **Thu·∫≠t to√°n RTT th√¥ng minh**: S·ª≠ d·ª•ng l·ªánh ping t√≠ch h·ª£p ƒë·ªÉ ƒëo RTT ri√™ng l·∫ª cho t·ª´ng host (3 ping m·ªói host), sau ƒë√≥ ch·ªçn th√¥ng minh gi·ªØa RTT trung b√¨nh v√† t·ªá nh·∫•t ƒë·ªÉ c√≥ hi·ªáu su·∫•t t·ªëi ∆∞u
- **Kh√°m ph√° giao di·ªán t·ª± ƒë·ªông**: T·ª± ƒë·ªông ph√°t hi·ªán c√°c giao di·ªán c√≥ CAKE ƒë∆∞·ª£c k√≠ch ho·∫°t
- **T√≠ch h·ª£p systemd**: Ch·∫°y nh∆∞ m·ªôt d·ªãch v·ª• systemd th√≠ch h·ª£p v·ªõi kh·ªüi ƒë·ªông t·ª± ƒë·ªông v√† qu·∫£n l√Ω ti·∫øn tr√¨nh
- **Tham s·ªë c√≥ th·ªÉ c·∫•u h√¨nh**: T·∫•t c·∫£ tham s·ªë th·ªùi gian v√† h√†nh vi c√≥ th·ªÉ c·∫•u h√¨nh qua t·ªáp c·∫•u h√¨nh
- **X·ª≠ l√Ω l·ªói m·∫°nh m·∫Ω**: X·ª≠ l√Ω m·ªôt c√°ch duy√™n d√°ng c√°c ph·ª• thu·ªôc b·ªã thi·∫øu, v·∫•n ƒë·ªÅ m·∫°ng v√† thay ƒë·ªïi giao di·ªán
- **Ph·ª• thu·ªôc t·ªëi thi·ªÉu**: Ch·ªâ c·∫ßn ping v√† tc - kh√¥ng c·∫ßn g√≥i b·ªï sung, s·ª≠ d·ª•ng ti·ªán √≠ch t√≠ch h·ª£p c√≥ s·∫µn tr√™n t·∫•t c·∫£ h·ªá th·ªëng
- **RTT ƒë·ªô ch√≠nh x√°c cao**: H·ªó tr·ª£ gi√° tr·ªã RTT ph√¢n s·ªë (v√≠ d·ª•: 100.23ms) ƒë·ªÉ ƒëi·ªÅu ch·ªânh th·ªùi gian m·∫°ng ch√≠nh x√°c

## üîß T∆∞∆°ng th√≠ch

**ƒê√£ ki·ªÉm tra v√† ho·∫°t ƒë·ªông:**
- **Ubuntu 20.04+ (Focal tr·ªü l√™n)**
- **Debian 10+ (Buster tr·ªü l√™n)**

**T∆∞∆°ng th√≠ch d·ª± ki·∫øn:**
- B·∫•t k·ª≥ b·∫£n ph√¢n ph·ªëi Linux d·ª±a tr√™n systemd n√†o c√≥ h·ªó tr·ª£ CAKE qdisc
- C√°c b·∫£n ph√¢n ph·ªëi v·ªõi g√≥i iproute2 hi·ªán ƒë·∫°i

**Y√™u c·∫ßu t∆∞∆°ng th√≠ch:**
- M√¥-ƒëun kernel CAKE qdisc (c√≥ s·∫µn trong Linux 4.19+)
- Ti·ªán √≠ch ping (bao g·ªìm trong t·∫•t c·∫£ b·∫£n ph√¢n ph·ªëi Linux ti√™u chu·∫©n)
- Qu·∫£n l√Ω d·ªãch v·ª• systemd
- iproute2 v·ªõi ti·ªán √≠ch tc (ki·ªÉm so√°t l∆∞u l∆∞·ª£ng)
- H·ªó tr·ª£ /proc/net/nf_conntrack (netfilter conntrack)

## üìã Y√™u c·∫ßu

### Ph·ª• thu·ªôc
- **ping**: Ti·ªán √≠ch ping ti√™u chu·∫©n ƒë·ªÉ ƒëo RTT (bao g·ªìm trong t·∫•t c·∫£ b·∫£n ph√¢n ph·ªëi Linux)
- **tc**: Ti·ªán √≠ch ki·ªÉm so√°t l∆∞u l∆∞·ª£ng (m·ªôt ph·∫ßn c·ªßa iproute2)
- **CAKE qdisc**: Ph·∫£i ƒë∆∞·ª£c c·∫•u h√¨nh tr√™n c√°c giao di·ªán ƒë√≠ch
- **systemd**: Qu·∫£n l√Ω d·ªãch v·ª•
- **netfilter conntrack**: ƒê·ªÉ theo d√µi k·∫øt n·ªëi (/proc/net/nf_conntrack)

### C√†i ƒë·∫∑t ph·ª• thu·ªôc

```bash
# C√†i ƒë·∫∑t c√°c g√≥i c·∫ßn thi·∫øt
sudo apt update
sudo apt install iputils-ping iproute2

# Ki·ªÉm tra xem tc c√≥ h·ªó tr·ª£ CAKE kh√¥ng:
tc qdisc help | grep cake

# Ki·ªÉm tra t√≠nh kh·∫£ d·ª•ng c·ªßa conntrack
ls /proc/net/nf_conntrack
```

## üîß C√†i ƒë·∫∑t

> [!IMPORTANT]  
> Tr∆∞·ªõc khi ch·∫°y script c√†i ƒë·∫∑t, b·∫°n PH·∫¢I c·∫•u h√¨nh CAKE qdisc tr√™n c√°c giao di·ªán m·∫°ng c·ªßa m√¨nh v√† ch·ªânh s·ª≠a t·ªáp c·∫•u h√¨nh ƒë·ªÉ ƒë·∫∑t t√™n giao di·ªán ch√≠nh x√°c cho h·ªá th·ªëng c·ªßa b·∫°n.

### ƒêi·ªÅu ki·ªán ti√™n quy·∫øt: C·∫•u h√¨nh CAKE qdisc

Tr∆∞·ªõc ti√™n, b·∫°n c·∫ßn c·∫•u h√¨nh CAKE qdisc tr√™n c√°c giao di·ªán m·∫°ng c·ªßa m√¨nh. ƒêi·ªÅu n√†y th∆∞·ªùng ƒë∆∞·ª£c th·ª±c hi·ªán tr√™n giao di·ªán h∆∞·ªõng internet:

```bash
# V√≠ d·ª•: C·∫•u h√¨nh CAKE tr√™n giao di·ªán ch√≠nh
# Thay th·∫ø 'eth0' b·∫±ng t√™n giao di·ªán th·ª±c t·∫ø c·ªßa b·∫°n
# Thay th·∫ø '100Mbit' b·∫±ng bƒÉng th√¥ng th·ª±c t·∫ø c·ªßa b·∫°n

# Cho c·∫•u h√¨nh ƒë∆°n gi·∫£n (thay th·∫ø eth0 b·∫±ng giao di·ªán c·ªßa b·∫°n):
sudo tc qdisc add root dev eth0 cake bandwidth 100Mbit

# Cho c·∫•u h√¨nh n√¢ng cao v·ªõi shaping ingress:
# T·∫°o giao di·ªán ifb (intermediate functional block) cho shaping download
sudo modprobe ifb
sudo ip link add name ifb0 type ifb
sudo ip link set dev ifb0 up

# C·∫•u h√¨nh chuy·ªÉn h∆∞·ªõng l∆∞u l∆∞·ª£ng ingress v√† CAKE
sudo tc qdisc add dev eth0 handle ffff: ingress
sudo tc filter add dev eth0 parent ffff: protocol all u32 match u32 0 0 action mirred egress redirect dev ifb0
sudo tc qdisc add root dev ifb0 cake bandwidth 500Mbit ingress

# C·∫•u h√¨nh CAKE egress
sudo tc qdisc add root dev eth0 cake bandwidth 50Mbit

# X√°c minh CAKE ƒë∆∞·ª£c c·∫•u h√¨nh
tc qdisc show | grep cake
```

### C√†i ƒë·∫∑t nhanh

1. **C·∫•u h√¨nh giao di·ªán CAKE (xem ph·∫ßn tr√™n)**

2. **Ch·ªânh s·ª≠a t·ªáp c·∫•u h√¨nh:**

```bash
# Ch·ªânh s·ª≠a t·ªáp c·∫•u h√¨nh ƒë·ªÉ ph√π h·ª£p v·ªõi t√™n giao di·ªán c·ªßa b·∫°n
nano etc/default/cake-autortt
```

3. **C·∫•u h√¨nh t√™n giao di·ªán c·ªßa b·∫°n:**

C·∫≠p nh·∫≠t c√†i ƒë·∫∑t `DL_INTERFACE` (download) v√† `UL_INTERFACE` (upload) ƒë·ªÉ ph√π h·ª£p v·ªõi c·∫•u h√¨nh m·∫°ng c·ªßa b·∫°n:

```bash
# V√≠ d·ª• c·∫•u h√¨nh cho c√°c thi·∫øt l·∫≠p kh√°c nhau:

# Cho thi·∫øt l·∫≠p ƒë∆°n gi·∫£n (m·ªôt giao di·ªán cho c·∫£ hai h∆∞·ªõng):
DL_INTERFACE="eth0"
UL_INTERFACE="eth0"

# Cho thi·∫øt l·∫≠p n√¢ng cao v·ªõi giao di·ªán ifb cho shaping ingress:
DL_INTERFACE="ifb0"     # Giao di·ªán download (ifb cho shaping l∆∞u l∆∞·ª£ng ingress)
UL_INTERFACE="eth0"     # Giao di·ªán upload (giao di·ªán v·∫≠t l√Ω)

# Cho t√™n giao di·ªán t√πy ch·ªânh:
DL_INTERFACE="enp3s0"   # Giao di·ªán download c·ª• th·ªÉ c·ªßa b·∫°n
UL_INTERFACE="enp3s0"   # Giao di·ªán upload c·ª• th·ªÉ c·ªßa b·∫°n
```

**C√°ch t√¨m t√™n giao di·ªán c·ªßa b·∫°n:**
```bash
# Li·ªát k√™ c√°c giao di·ªán c√≥ CAKE qdisc
tc qdisc show | grep cake

# Li·ªát k√™ t·∫•t c·∫£ giao di·ªán m·∫°ng
ip link show

# Ki·ªÉm tra giao di·ªán m·∫°ng ch√≠nh c·ªßa b·∫°n
ip route | grep default
```

4. **Ch·∫°y script c√†i ƒë·∫∑t:**

```bash
# L√†m cho script c√†i ƒë·∫∑t c√≥ th·ªÉ th·ª±c thi v√† ch·∫°y
chmod +x install.sh
sudo ./install.sh
```

### C√†i ƒë·∫∑t th·ªß c√¥ng

1. **Sao ch√©p t·ªáp d·ªãch v·ª• v√†o h·ªá th·ªëng c·ªßa b·∫°n:**

```bash
# Sao ch√©p t·ªáp th·ª±c thi ch√≠nh
sudo cp usr/bin/cake-autortt /usr/bin/
sudo chmod +x /usr/bin/cake-autortt

# Sao ch√©p t·ªáp d·ªãch v·ª• systemd
sudo cp etc/systemd/system/cake-autortt.service /etc/systemd/system/

# Sao ch√©p t·ªáp c·∫•u h√¨nh
sudo cp etc/default/cake-autortt /etc/default/

# Sao ch√©p quy t·∫Øc udev ƒë·ªÉ gi√°m s√°t giao di·ªán
sudo cp etc/udev/rules.d/99-cake-autortt.rules /etc/udev/rules.d/

# T·∫£i l·∫°i systemd v√† udev
sudo systemctl daemon-reload
sudo udevadm control --reload-rules
```

2. **K√≠ch ho·∫°t v√† kh·ªüi ƒë·ªông d·ªãch v·ª•:**

```bash
# K√≠ch ho·∫°t d·ªãch v·ª• ƒë·ªÉ kh·ªüi ƒë·ªông t·ª± ƒë·ªông khi boot
sudo systemctl enable cake-autortt

# Kh·ªüi ƒë·ªông d·ªãch v·ª•
sudo systemctl start cake-autortt
```

## üóëÔ∏è G·ª° c√†i ƒë·∫∑t

ƒê·ªÉ g·ª° cake-autortt kh·ªèi h·ªá th·ªëng c·ªßa b·∫°n:

```bash
# L√†m cho script g·ª° c√†i ƒë·∫∑t c√≥ th·ªÉ th·ª±c thi v√† ch·∫°y
chmod +x uninstall.sh
sudo ./uninstall.sh
```

Script g·ª° c√†i ƒë·∫∑t s·∫Ω:
- D·ª´ng v√† v√¥ hi·ªáu h√≥a d·ªãch v·ª•
- X√≥a t·∫•t c·∫£ t·ªáp ƒë√£ c√†i ƒë·∫∑t
- T√πy ch·ªçn x√≥a t·ªáp c·∫•u h√¨nh v√† sao l∆∞u
- D·ªçn d·∫πp t·ªáp t·∫°m th·ªùi

## ‚öôÔ∏è C·∫•u h√¨nh

### üîß C·∫•u h√¨nh giao di·ªán (B·∫ÆT BU·ªòC)

**B∆∞·ªõc c·∫•u h√¨nh quan tr·ªçng nh·∫•t l√† ƒë·∫∑t t√™n giao di·ªán ch√≠nh x√°c.** D·ªãch v·ª• s·∫Ω kh√¥ng ho·∫°t ƒë·ªông ƒë√∫ng c√°ch m√† kh√¥ng c√≥ t√™n giao di·ªán ch√≠nh x√°c.

```bash
# Xem c·∫•u h√¨nh hi·ªán t·∫°i
cat /etc/default/cake-autortt

# Ch·ªânh s·ª≠a c·∫•u h√¨nh
sudo nano /etc/default/cake-autortt

# Kh·ªüi ƒë·ªông l·∫°i d·ªãch v·ª• ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
sudo systemctl restart cake-autortt
```

D·ªãch v·ª• ƒë∆∞·ª£c c·∫•u h√¨nh qua `/etc/default/cake-autortt`. T·∫•t c·∫£ tham s·ªë c√≥ th·ªÉ ƒë∆∞·ª£c c·∫•u h√¨nh b·∫±ng c√°ch ch·ªânh s·ª≠a t·ªáp n√†y.

### Tham s·ªë c·∫•u h√¨nh

| Tham s·ªë | M·∫∑c ƒë·ªãnh | M√¥ t·∫£ |
|-----------|---------|-------------|
| `DL_INTERFACE` | auto | T√™n giao di·ªán download (v√≠ d·ª•: 'eth0', 'ifb0') |
| `UL_INTERFACE` | auto | T√™n giao di·ªán upload (v√≠ d·ª•: 'eth0', 'enp3s0') |
| `RTT_UPDATE_INTERVAL` | 5 | Gi√¢y gi·ªØa c√°c l·∫ßn c·∫≠p nh·∫≠t tham s·ªë RTT qdisc |
| `MIN_HOSTS` | 3 | S·ªë l∆∞·ª£ng host t·ªëi thi·ªÉu c·∫ßn thi·∫øt ƒë·ªÉ t√≠nh to√°n RTT |
| `MAX_HOSTS` | 100 | S·ªë l∆∞·ª£ng host t·ªëi ƒëa ƒë·ªÉ probe tu·∫ßn t·ª± |
| `RTT_MARGIN_PERCENT` | 10 | L·ªÅ an to√†n ƒë∆∞·ª£c th√™m v√†o RTT ƒëo ƒë∆∞·ª£c (ph·∫ßn trƒÉm) |
| `DEFAULT_RTT_MS` | 100 | RTT m·∫∑c ƒë·ªãnh khi kh√¥ng ƒë·ªß host c√≥ s·∫µn |
| `DEBUG` | 0 | K√≠ch ho·∫°t ghi log debug (0=t·∫Øt, 1=b·∫≠t) |

> [!NOTE]  
> M·∫∑c d√π c√°c tham s·ªë giao di·ªán c√≥ m·∫∑c ƒë·ªãnh "auto", t·ª± ƒë·ªông ph√°t hi·ªán c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông ƒë√°ng tin c·∫≠y trong t·∫•t c·∫£ c·∫•u h√¨nh. R·∫•t khuy·∫øn kh√≠ch ƒë·∫∑t c√°c gi√° tr·ªã n√†y m·ªôt c√°ch r√µ r√†ng.

> [!TIP]  
> ƒê·ªëi v·ªõi m·∫°ng ho·∫°t ƒë·ªông cao (v√≠ d·ª•: khu√¥n vi√™n ƒë·∫°i h·ªçc, m·∫°ng c√¥ng c·ªông v·ªõi nhi·ªÅu ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông), h√£y xem x√©t ƒëi·ªÅu ch·ªânh `RTT_UPDATE_INTERVAL` d·ª±a tr√™n ƒë·∫∑c ƒëi·ªÉm m·∫°ng c·ªßa b·∫°n. M·∫∑c ƒë·ªãnh 5 gi√¢y ho·∫°t ƒë·ªông t·ªët cho h·∫ßu h·∫øt c√°c t√¨nh hu·ªëng, nh∆∞ng b·∫°n c√≥ th·ªÉ tƒÉng l√™n 10-15 gi√¢y cho m·∫°ng ·ªïn ƒë·ªãnh h∆°n ho·∫∑c gi·∫£m xu·ªëng 3 gi√¢y cho m√¥i tr∆∞·ªùng r·∫•t ƒë·ªông.

### V√≠ d·ª• c·∫•u h√¨nh

```bash
# /etc/default/cake-autortt

# Giao di·ªán m·∫°ng (B·∫ÆT BU·ªòC - c·∫•u h√¨nh cho c√†i ƒë·∫∑t c·ªßa b·∫°n)
DL_INTERFACE="ifb0"      # Giao di·ªán download
UL_INTERFACE="eth0"      # Giao di·ªán upload

# Tham s·ªë th·ªùi gian
RTT_UPDATE_INTERVAL=5    # C·∫≠p nh·∫≠t RTT m·ªói 5 gi√¢y
MIN_HOSTS=3              # C·∫ßn t·ªëi thi·ªÉu 3 host ƒë·ªÉ ƒëo
MAX_HOSTS=100            # L·∫•y m·∫´u t·ªëi ƒëa 100 host
RTT_MARGIN_PERCENT=10    # Th√™m 10% l·ªÅ an to√†n
DEFAULT_RTT_MS=100       # Gi√° tr·ªã RTT d·ª± ph√≤ng

# Debug
DEBUG=0                  # ƒê·∫∑t th√†nh 1 cho ghi log chi ti·∫øt
```

## üîç C√°ch ho·∫°t ƒë·ªông

1. **Gi√°m s√°t k·∫øt n·ªëi**: ƒê·ªãnh k·ª≥ ph√¢n t√≠ch `/proc/net/nf_conntrack` ƒë·ªÉ x√°c ƒë·ªãnh k·∫øt n·ªëi m·∫°ng ho·∫°t ƒë·ªông
2. **L·ªçc host**: Tr√≠ch xu·∫•t ƒë·ªãa ch·ªâ IP ƒë√≠ch v√† l·ªçc ƒë·ªãa ch·ªâ ri√™ng t∆∞/LAN
3. **ƒêo RTT**: S·ª≠ d·ª•ng `ping` ƒë·ªÉ ƒëo RTT ri√™ng l·∫ª cho t·ª´ng host b√™n ngo√†i (3 ping m·ªói host)
4. **L·ª±a ch·ªçn RTT th√¥ng minh**: Ping c√°c host tu·∫ßn t·ª± ƒë·ªÉ tr√°nh t·∫Øc ngh·∫Ωn m·∫°ng, t√≠nh to√°n RTT trung b√¨nh v√† t·ªá nh·∫•t, sau ƒë√≥ s·ª≠ d·ª•ng gi√° tr·ªã cao h∆°n ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªáu su·∫•t t·ªëi ∆∞u cho t·∫•t c·∫£ k·∫øt n·ªëi
5. **L·ªÅ an to√†n**: Th√™m l·ªÅ c√≥ th·ªÉ c·∫•u h√¨nh v√†o RTT ƒëo ƒë∆∞·ª£c ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªám ƒë·∫ßy ƒë·ªß
6. **C·∫≠p nh·∫≠t qdisc**: C·∫≠p nh·∫≠t tham s·ªë RTT CAKE qdisc tr√™n giao di·ªán download v√† upload

### üß† Thu·∫≠t to√°n RTT th√¥ng minh

K·ªÉ t·ª´ phi√™n b·∫£n 1.2.0, cake-autortt tri·ªÉn khai thu·∫≠t to√°n l·ª±a ch·ªçn RTT th√¥ng minh d·ª±a tr√™n khuy·∫øn ngh·ªã c·ªßa Dave T√§ht (ƒë·ªìng t√°c gi·∫£ CAKE):

**V·∫•n ƒë·ªÅ**: Ch·ªâ s·ª≠ d·ª•ng RTT trung b√¨nh c√≥ th·ªÉ c√≥ v·∫•n ƒë·ªÅ khi m·ªôt s·ªë host c√≥ ƒë·ªô tr·ªÖ cao h∆°n ƒë√°ng k·ªÉ so v·ªõi nh·ªØng host kh√°c. V√≠ d·ª•, n·∫øu b·∫°n c√≥ 100 host v·ªõi RTT trung b√¨nh 40ms, nh∆∞ng 2 host c√≥ RTT 234ms v√† 240ms, vi·ªác s·ª≠ d·ª•ng trung b√¨nh 40ms c√≥ th·ªÉ g√¢y ra v·∫•n ƒë·ªÅ hi·ªáu su·∫•t cho nh·ªØng k·∫øt n·ªëi ƒë·ªô tr·ªÖ cao n√†y.

**Gi·∫£i ph√°p**: Thu·∫≠t to√°n hi·ªán t·∫°i:
1. **T√≠nh to√°n c·∫£ RTT trung b√¨nh v√† t·ªá nh·∫•t** t·ª´ t·∫•t c·∫£ host ph·∫£n h·ªìi
2. **So s√°nh hai gi√° tr·ªã** v√† ch·ªçn th√¥ng minh c√°i ph√π h·ª£p
3. **S·ª≠ d·ª•ng RTT t·ªá nh·∫•t khi n√≥ cao h∆°n ƒë√°ng k·ªÉ** so v·ªõi trung b√¨nh ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªáu su·∫•t t·ªët cho t·∫•t c·∫£ k·∫øt n·ªëi
4. **S·ª≠ d·ª•ng RTT trung b√¨nh khi RTT t·ªá nh·∫•t g·∫ßn** v·ªõi trung b√¨nh ƒë·ªÉ tr√°nh c√†i ƒë·∫∑t qu√° b·∫£o th·ªß

**T·∫°i sao ƒëi·ªÅu n√†y quan tr·ªçng**: Theo [Dave T√§ht](https://forum.mikrotik.com/t/fq-codel-cake-stories/181067/17), "t·ªët h∆°n, ƒë·∫∑c bi·ªát v·ªõi shaping ingress, l√† s·ª≠ d·ª•ng RTT ƒëi·ªÉn h√¨nh c·ªßa b·∫°n l√†m ∆∞·ªõc t√≠nh ƒë·ªÉ c√≥ ƒë∆∞·ª£c ki·ªÉm so√°t h√†ng ƒë·ª£i tr∆∞·ªõc khi n√≥ ƒë·∫øn shaper ISP m√† b·∫°n ƒëang ƒë√°nh b·∫°i." Tuy nhi√™n, n·∫øu RTT th·ª±c t·∫ø ƒë·∫øn b·∫•t k·ª≥ host n√†o d√†i h∆°n RTT ƒë∆∞·ª£c ƒë·∫∑t tr√™n giao di·ªán CAKE, hi·ªáu su·∫•t c√≥ th·ªÉ b·ªã ·∫£nh h∆∞·ªüng nghi√™m tr·ªçng.

**V√≠ d·ª• th·ª±c t·∫ø**:
- 98 host v·ªõi RTT 30-50ms (trung b√¨nh: 42ms)
- 2 host v·ªõi RTT 200ms+ (t·ªá nh·∫•t: 234ms)
- **Thu·∫≠t to√°n c≈©**: S·∫Ω s·ª≠ d·ª•ng trung b√¨nh 45ms, g√¢y ra v·∫•n ƒë·ªÅ cho host 200ms+
- **Thu·∫≠t to√°n m·ªõi**: S·ª≠ d·ª•ng RTT t·ªá nh·∫•t 234ms, ƒë·∫£m b·∫£o hi·ªáu su·∫•t t·ªëi ∆∞u cho t·∫•t c·∫£ k·∫øt n·ªëi

### V√≠ d·ª• lu·ªìng k·∫øt n·ªëi

```
[Host/·ª®ng d·ª•ng] ‚Üí [CAKE tr√™n giao di·ªán] ‚Üí [Internet]
                            ‚Üë
                      cake-autortt gi√°m s√°t
                      k·∫øt n·ªëi ho·∫°t ƒë·ªông v√†
                      ƒëi·ªÅu ch·ªânh tham s·ªë RTT
```

## üìä H√†nh vi mong ƒë·ª£i

Sau khi c√†i ƒë·∫∑t v√† kh·ªüi ƒë·ªông, b·∫°n n√™n quan s√°t:

### Hi·ªáu ·ª©ng t·ª©c th√¨
- D·ªãch v·ª• t·ª± ƒë·ªông kh·ªüi ƒë·ªông qua systemd v√† b·∫Øt ƒë·∫ßu gi√°m s√°t k·∫øt n·ªëi
- C√°c ph√©p ƒëo RTT ƒë∆∞·ª£c ghi v√†o log h·ªá th·ªëng (n·∫øu debug ƒë∆∞·ª£c k√≠ch ho·∫°t)
- Tham s·ªë RTT CAKE qdisc ƒë∆∞·ª£c c·∫≠p nh·∫≠t m·ªói 30 gi√¢y d·ª±a tr√™n ƒëi·ªÅu ki·ªán m·∫°ng ƒëo ƒë∆∞·ª£c
- Gi√° tr·ªã RTT ƒë·ªô ch√≠nh x√°c cao (v√≠ d·ª•: 44.89ms) ƒë∆∞·ª£c √°p d·ª•ng cho CAKE qdisc

### L·ª£i √≠ch d√†i h·∫°n
- **C·∫£i thi·ªán kh·∫£ nƒÉng ph·∫£n h·ªìi**: Tham s·ªë RTT lu√¥n c·∫≠p nh·∫≠t v·ªõi ƒëi·ªÅu ki·ªán m·∫°ng th·ª±c t·∫ø
- **Ki·ªÉm so√°t Bufferbloat t·ªët h∆°n**: CAKE c√≥ th·ªÉ ƒë∆∞a ra quy·∫øt ƒë·ªãnh th√¥ng tin h∆°n v·ªÅ qu·∫£n l√Ω h√†ng ƒë·ª£i
- **Hi·ªáu su·∫•t th√≠ch ·ª©ng**: T·ª± ƒë·ªông th√≠ch ·ª©ng v·ªõi ƒëi·ªÅu ki·ªán m·∫°ng thay ƒë·ªïi (v·ªá tinh, di ƒë·ªông, li√™n k·∫øt t·∫Øc ngh·∫Ωn)
- **ƒê·ªô ch√≠nh x√°c cao h∆°n**: L·∫•y m·∫´u t·ªëi ƒëa 20 host ƒë·ªÉ ƒë·∫°i di·ªán t·ªët h∆°n cho ƒëi·ªÅu ki·ªán m·∫°ng

### Gi√°m s√°t

```bash
# Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•
sudo systemctl status cake-autortt

# Xem log d·ªãch v·ª•
sudo journalctl -u cake-autortt -f

# Gi√°m s√°t tham s·ªë CAKE qdisc
tc qdisc show | grep cake

# Ch·∫ø ƒë·ªô debug cho ghi log chi ti·∫øt
sudo nano /etc/default/cake-autortt
# ƒê·∫∑t DEBUG=1, sau ƒë√≥:
sudo systemctl restart cake-autortt
```

## üîß Kh·∫Øc ph·ª•c s·ª± c·ªë

### V·∫•n ƒë·ªÅ th∆∞·ªùng g·∫∑p

1. **D·ªãch v·ª• kh√¥ng kh·ªüi ƒë·ªông**
   ```bash
   # Ki·ªÉm tra ph·ª• thu·ªôc
   which ping tc
   
   # Ki·ªÉm tra giao di·ªán CAKE
   tc qdisc show | grep cake
   
   # Ki·ªÉm tra log d·ªãch v·ª•
   sudo journalctl -u cake-autortt --no-pager
   ```

2. **Kh√¥ng c√≥ c·∫≠p nh·∫≠t RTT**
   ```bash
   # K√≠ch ho·∫°t ch·∫ø ƒë·ªô debug
   sudo nano /etc/default/cake-autortt
   # ƒê·∫∑t DEBUG=1
   
   sudo systemctl restart cake-autortt
   
   # Ki·ªÉm tra log
   sudo journalctl -u cake-autortt -f
   ```

3. **Ph√°t hi·ªán giao di·ªán th·∫•t b·∫°i**
   ```bash
   # Ch·ªâ ƒë·ªãnh giao di·ªán th·ªß c√¥ng trong c·∫•u h√¨nh
   sudo nano /etc/default/cake-autortt
   # ƒê·∫∑t DL_INTERFACE v√† UL_INTERFACE
   
   sudo systemctl restart cake-autortt
   ```

4. **Kh√¥ng t√¨m th·∫•y CAKE qdisc**
   ```bash
   # Ki·ªÉm tra h·ªó tr·ª£ CAKE
   tc qdisc help | grep cake
   
   # Ki·ªÉm tra xem CAKE c√≥ ƒë∆∞·ª£c c·∫•u h√¨nh tr√™n giao di·ªán kh√¥ng
   tc qdisc show
   
   # C·∫•u h√¨nh CAKE n·∫øu c·∫ßn (xem ph·∫ßn c√†i ƒë·∫∑t)
   ```

### Th√¥ng tin debug

V·ªõi debug ƒë∆∞·ª£c k√≠ch ho·∫°t (`DEBUG=1` trong `/etc/default/cake-autortt`), d·ªãch v·ª• cung c·∫•p ghi log chi ti·∫øt:

**V√≠ d·ª• ƒë·∫ßu ra debug:**
```bash
Jan 09 18:34:22 hostname cake-autortt[1234]: DEBUG: Extracting hosts from conntrack
Jan 09 18:34:22 hostname cake-autortt[1234]: DEBUG: Found 35 non-LAN hosts
Jan 09 18:34:22 hostname cake-autortt[1234]: DEBUG: Measuring RTT using ping for 35 hosts (3 pings each)
Jan 09 18:34:25 hostname cake-autortt[1234]: DEBUG: ping summary: 28/35 hosts alive
Jan 09 18:34:25 hostname cake-autortt[1234]: DEBUG: Using average RTT: 45.2ms (avg: 45.2ms, worst: 89.1ms)
Jan 09 18:34:25 hostname cake-autortt[1234]: DEBUG: Using measured RTT: 45.2ms
Jan 09 18:34:35 hostname cake-autortt[1234]: INFO: Adjusting CAKE RTT to 49.72ms (49720us)
Jan 09 18:34:35 hostname cake-autortt[1234]: DEBUG: Updated RTT on download interface ifb0
Jan 09 18:34:35 hostname cake-autortt[1234]: DEBUG: Updated RTT on upload interface eth0
```

> [!NOTE]  
> **Ghi log hi·ªáu qu·∫£ b·ªô nh·ªõ**: Ghi log debug ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a ƒë·ªÉ ngƒÉn ch·∫∑n tr√†n log. C√°c ph√©p ƒëo RTT host ri√™ng l·∫ª kh√¥ng ƒë∆∞·ª£c ghi log ƒë·ªÉ gi·∫£m s·ª≠ d·ª•ng b·ªô nh·ªõ v√† ghi ƒëƒ©a. Ch·ªâ th√¥ng tin t√≥m t·∫Øt ƒë∆∞·ª£c ghi v√†o journal systemd, l√†m cho n√≥ ph√π h·ª£p cho ho·∫°t ƒë·ªông li√™n t·ª•c m√† kh√¥ng tƒÉng tr∆∞·ªüng log qu√° m·ª©c.

## üîÑ Kh√°c bi·ªát v·ªõi phi√™n b·∫£n OpenWrt

B·∫£n port Ubuntu/Debian n√†y kh√°c v·ªõi phi√™n b·∫£n OpenWrt ·ªü m·ªôt s·ªë kh√≠a c·∫°nh ch√≠nh:

### H·ªá th·ªëng c·∫•u h√¨nh
- **OpenWrt**: S·ª≠ d·ª•ng h·ªá th·ªëng c·∫•u h√¨nh UCI (`uci set`, `/etc/config/cake-autortt`)
- **Ubuntu/Debian**: S·ª≠ d·ª•ng t·ªáp c·∫•u h√¨nh truy·ªÅn th·ªëng (`/etc/default/cake-autortt`)

### Qu·∫£n l√Ω d·ªãch v·ª•
- **OpenWrt**: S·ª≠ d·ª•ng procd v√† script init.d OpenWrt
- **Ubuntu/Debian**: S·ª≠ d·ª•ng qu·∫£n l√Ω d·ªãch v·ª• systemd

### Gi√°m s√°t giao di·ªán
- **OpenWrt**: S·ª≠ d·ª•ng script hotplug.d cho s·ª± ki·ªán giao di·ªán
- **Ubuntu/Debian**: S·ª≠ d·ª•ng quy t·∫Øc udev cho gi√°m s√°t giao di·ªán

### Qu·∫£n l√Ω g√≥i
- **OpenWrt**: S·ª≠ d·ª•ng tr√¨nh qu·∫£n l√Ω g√≥i opkg
- **Ubuntu/Debian**: S·ª≠ d·ª•ng tr√¨nh qu·∫£n l√Ω g√≥i apt

### V·ªã tr√≠ t·ªáp
- **OpenWrt**: S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n c·ª• th·ªÉ OpenWrt (`/etc/config/`, `/etc/hotplug.d/`)
- **Ubuntu/Debian**: S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n Linux ti√™u chu·∫©n (`/etc/default/`, `/etc/systemd/`, `/etc/udev/`)

## üìÑ Gi·∫•y ph√©p

D·ª± √°n n√†y ƒë∆∞·ª£c c·∫•p ph√©p theo GNU General Public License v2.0 - xem t·ªáp [LICENSE](../LICENSE) ƒë·ªÉ bi·∫øt chi ti·∫øt.

## ü§ù ƒê√≥ng g√≥p

ƒê√≥ng g√≥p ƒë∆∞·ª£c hoan ngh√™nh! Vui l√≤ng g·ª≠i Pull Request. Khi ƒë√≥ng g√≥p cho b·∫£n port Ubuntu/Debian, vui l√≤ng ƒë·∫£m b·∫£o t∆∞∆°ng th√≠ch v·ªõi c·∫£ phi√™n b·∫£n Ubuntu LTS v√† Debian stable hi·ªán t·∫°i.