# cake-autortt

## üåê Language / ËØ≠Ë®Ä / Bahasa / –Ø–∑—ã–∫ / Ë®ÄË™û / Ng√¥n ng·ªØ / Dil / ÿßŸÑŸÑÿ∫ÿ©

[English](README.md) | [‰∏≠Êñá](README_zh.md) | [Bahasa Indonesia](README_id.md) | [–†—É—Å—Å–∫–∏–π](README_ru.md) | [Êó•Êú¨Ë™û](README_ja.md) | **Ti·∫øng Vi·ªát** | [T√ºrk√ße](README_tr.md) | [ÿßŸÑÿπÿ±ÿ®Ÿäÿ©](README_ar.md)

---

**T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh tham s·ªë RTT c·ªßa CAKE qdisc d·ª±a tr√™n ƒëi·ªÅu ki·ªán m·∫°ng ƒëo ƒë∆∞·ª£c**

> [!NOTE]  
> N·∫øu b·∫°n ƒëang t√¨m ki·∫øm **phi√™n b·∫£n Ubuntu/Debian**, h√£y ki·ªÉm tra th∆∞ m·ª•c `ubuntu-debian/`. Tuy nhi√™n, l∆∞u √Ω r·∫±ng ch·ªâ c√≥ phi√™n b·∫£n OpenWrt ƒë∆∞·ª£c ki·ªÉm tra c√° nh√¢n h√†ng ng√†y - b·∫£n port Ubuntu/Debian ƒë∆∞·ª£c cung c·∫•p nh∆∞ hi·ªán t·∫°i cho c·ªông ƒë·ªìng.

`cake-autortt` l√† m·ªôt d·ªãch v·ª• OpenWrt th√¥ng minh gi√°m s√°t c√°c k·∫øt n·ªëi m·∫°ng ho·∫°t ƒë·ªông v√† t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh tham s·ªë RTT (Round Trip Time) c·ªßa CAKE qdisc tr√™n c√°c giao di·ªán ƒë·∫øn v√† ƒëi ƒë·ªÉ c√≥ hi·ªáu su·∫•t m·∫°ng t·ªëi ∆∞u.

## üåç T·∫°i sao ƒëi·ªÅu n√†y quan tr·ªçng ƒë·ªëi v·ªõi tr·∫£i nghi·ªám Internet c·ªßa b·∫°n

H·∫ßu h·∫øt ng∆∞·ªùi d√πng ƒë√£ quen v·ªõi th·ªùi gian t·∫£i nhanh c·ªßa c√°c trang web ch√≠nh nh∆∞ YouTube, Netflix v√† Google - nh·ªØng trang n√†y s·ª≠ d·ª•ng m·∫°ng ph√¢n ph·ªëi n·ªôi dung (CDN) ƒë·∫∑t m√°y ch·ªß r·∫•t g·∫ßn ng∆∞·ªùi d√πng, th∆∞·ªùng cung c·∫•p th·ªùi gian ph·∫£n h·ªìi d∆∞·ªõi 50-100ms. Tuy nhi√™n, Internet l·ªõn h∆°n nhi·ªÅu so v·ªõi nh·ªØng n·ªÅn t·∫£ng l·ªõn n√†y.

**Khi b·∫°n duy·ªát c√°c trang web ngo√†i nh·ªØng trang ch√≠nh ƒë∆∞·ª£c h·ªó tr·ª£ b·ªüi CDN, b·∫°n g·∫∑p ph·∫£i m·ªôt th·∫ø gi·ªõi ƒëa d·∫°ng c·ªßa c√°c m√°y ch·ªß:**
- **D·ªãch v·ª• ƒê·ªãa ph∆∞∆°ng/Khu v·ª±c**: Doanh nghi·ªáp nh·ªè, trang tin t·ª©c ƒë·ªãa ph∆∞∆°ng, di·ªÖn ƒë√†n c·ªông ƒë·ªìng v√† d·ªãch v·ª• khu v·ª±c th∆∞·ªùng c√≥ m√°y ch·ªß trong qu·ªëc gia ho·∫∑c khu v·ª±c c·ªßa b·∫°n (10-50ms RTT)
- **N·ªôi dung Qu·ªëc t·∫ø**: C√°c trang web chuy√™n bi·ªát, t√†i nguy√™n h·ªçc thu·∫≠t, m√°y ch·ªß game v√† d·ªãch v·ª• ng√°ch c√≥ th·ªÉ ƒë∆∞·ª£c l∆∞u tr·ªØ tr√™n c√°c l·ª•c ƒë·ªãa kh√°c (100-500ms RTT)
- **C∆° s·ªü h·∫° t·∫ßng T·ª´ xa**: M·ªôt s·ªë d·ªãch v·ª•, ƒë·∫∑c bi·ªát l√† ·ªü c√°c khu v·ª±c ƒëang ph√°t tri·ªÉn ho·∫∑c ·ª©ng d·ª•ng chuy√™n bi·ªát, c√≥ th·ªÉ c√≥ ƒë·ªô tr·ªÖ cao ƒë√°ng k·ªÉ

**Tham s·ªë CAKE RTT ki·ªÉm so√°t m·ª©c ƒë·ªô t√≠ch c·ª±c c·ªßa thu·∫≠t to√°n x·∫øp h√†ng ph·∫£n ·ª©ng v·ªõi t·∫Øc ngh·∫Ωn.** Theo m·∫∑c ƒë·ªãnh, CAKE s·ª≠ d·ª•ng gi·∫£ ƒë·ªãnh RTT 100ms, ho·∫°t ƒë·ªông kh√° t·ªët cho l∆∞u l∆∞·ª£ng Internet chung. Tuy nhi√™n:

- **C√†i ƒë·∫∑t RTT qu√° th·∫•p**: N·∫øu CAKE nghƒ© RTT m·∫°ng ng·∫Øn h∆°n th·ª±c t·∫ø, n√≥ tr·ªü n√™n qu√° t√≠ch c·ª±c trong vi·ªác lo·∫°i b·ªè g√≥i tin khi ƒë·ªãnh h√¨nh h√†ng ƒë·ª£i, c√≥ th·ªÉ l√†m gi·∫£m bƒÉng th√¥ng cho c√°c m√°y ch·ªß t·ª´ xa
- **C√†i ƒë·∫∑t RTT qu√° cao**: N·∫øu CAKE nghƒ© RTT m·∫°ng d√†i h∆°n th·ª±c t·∫ø, n√≥ tr·ªü n√™n qu√° b·∫£o th·ªß v√† cho ph√©p h√¨nh th√†nh h√†ng ƒë·ª£i l·ªõn, t·∫°o ra ƒë·ªô tr·ªÖ kh√¥ng c·∫ßn thi·∫øt cho c√°c m√°y ch·ªß g·∫ßn

**V√≠ d·ª• t√°c ƒë·ªông th·ª±c t·∫ø:**
- **Ng∆∞·ªùi d√πng Singapore ‚Üí M√°y ch·ªß ƒê·ª©c**: Kh√¥ng c√≥ ƒëi·ªÅu ch·ªânh RTT, ng∆∞·ªùi d√πng ·ªü Singapore truy c·∫≠p trang web ƒê·ª©c (‚âà180ms RTT) c√≥ th·ªÉ g·∫∑p bƒÉng th√¥ng gi·∫£m do c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh 100ms c·ªßa CAKE g√¢y ra vi·ªác lo·∫°i b·ªè g√≥i tin s·ªõm
- **N√¥ng th√¥n M·ªπ ‚Üí M√°y ch·ªß Khu v·ª±c**: Ng∆∞·ªùi d√πng ·ªü n√¥ng th√¥n M·ªπ truy c·∫≠p m√°y ch·ªß khu v·ª±c (‚âà25ms RTT) c√≥ th·ªÉ g·∫∑p ƒë·ªô tr·ªÖ cao h∆°n c·∫ßn thi·∫øt do c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh 100ms c·ªßa CAKE cho ph√©p h√†ng ƒë·ª£i ph√°t tri·ªÉn l·ªõn h∆°n c·∫ßn thi·∫øt
- **·ª®ng d·ª•ng Game/Th·ªùi gian th·ª±c**: C√°c ·ª©ng d·ª•ng nh·∫°y c·∫£m v·ªõi c·∫£ ƒë·ªô tr·ªÖ v√† bƒÉng th√¥ng ƒë·ªÅu ƒë∆∞·ª£c h∆∞·ªüng l·ª£i ƒë√°ng k·ªÉ t·ª´ vi·ªác ƒëi·ªÅu ch·ªânh RTT ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán m·∫°ng th·ª±c t·∫ø

**C√°ch cake-autortt gi√∫p ƒë·ª°:**
B·∫±ng c√°ch t·ª± ƒë·ªông ƒëo RTT th·ª±c t·∫ø ƒë·∫øn c√°c m√°y ch·ªß b·∫°n ƒëang giao ti·∫øp v√† ƒëi·ªÅu ch·ªânh tham s·ªë CAKE t∆∞∆°ng ·ª©ng, b·∫°n nh·∫≠n ƒë∆∞·ª£c:
- **Ph·∫£n h·ªìi nhanh h∆°n** khi truy c·∫≠p m√°y ch·ªß g·∫ßn (RTT ng·∫Øn h∆°n ‚Üí qu·∫£n l√Ω h√†ng ƒë·ª£i t√≠ch c·ª±c h∆°n)
- **BƒÉng th√¥ng t·ªët h∆°n** khi truy c·∫≠p m√°y ch·ªß t·ª´ xa (RTT d√†i h∆°n ‚Üí qu·∫£n l√Ω h√†ng ƒë·ª£i ki√™n nh·∫´n h∆°n)
- **Ki·ªÉm so√°t bufferbloat t·ªëi ∆∞u** th√≠ch ·ª©ng v·ªõi ƒëi·ªÅu ki·ªán m·∫°ng th·ª±c t·∫ø thay v√¨ gi·∫£ ƒë·ªãnh

ƒêi·ªÅu n√†y ƒë·∫∑c bi·ªát c√≥ gi√° tr·ªã cho ng∆∞·ªùi d√πng th∆∞·ªùng xuy√™n truy c·∫≠p c√°c ngu·ªìn n·ªôi dung ƒëa d·∫°ng, l√†m vi·ªác v·ªõi d·ªãch v·ª• qu·ªëc t·∫ø, ho·∫∑c s·ªëng ·ªü nh·ªØng khu v·ª±c m√† l∆∞u l∆∞·ª£ng Internet th∆∞·ªùng ƒëi qua kho·∫£ng c√°ch l·ªõn.

## üöÄ T√≠nh nƒÉng

- **Ph√°t hi·ªán RTT T·ª± ƒë·ªông**: Gi√°m s√°t c√°c k·∫øt n·ªëi ho·∫°t ƒë·ªông th√¥ng qua `/proc/net/nf_conntrack` v√† ƒëo RTT ƒë·∫øn c√°c host b√™n ngo√†i
- **L·ªçc Host Th√¥ng minh**: T·ª± ƒë·ªông l·ªçc ƒë·ªãa ch·ªâ LAN v√† t·∫≠p trung v√†o c√°c host b√™n ngo√†i
- **Thu·∫≠t to√°n RTT Th√¥ng minh**: S·ª≠ d·ª•ng l·ªánh ping t√≠ch h·ª£p ƒë·ªÉ ƒëo RTT c·ªßa t·ª´ng host ri√™ng l·∫ª (3 ping m·ªói host), sau ƒë√≥ th√¥ng minh l·ª±a ch·ªçn gi·ªØa RTT trung b√¨nh v√† t·ªá nh·∫•t ƒë·ªÉ c√≥ hi·ªáu su·∫•t t·ªëi ∆∞u
- **Ph√°t hi·ªán Giao di·ªán T·ª± ƒë·ªông**: T·ª± ƒë·ªông ph√°t hi·ªán c√°c giao di·ªán c√≥ CAKE (∆∞u ti√™n `ifb-*` cho download, giao di·ªán v·∫≠t l√Ω cho upload)
- **T√≠ch h·ª£p D·ªãch v·ª• OpenWrt**: Ho·∫°t ƒë·ªông nh∆∞ m·ªôt d·ªãch v·ª• OpenWrt th√≠ch h·ª£p v·ªõi kh·ªüi ƒë·ªông t·ª± ƒë·ªông v√† qu·∫£n l√Ω ti·∫øn tr√¨nh
- **Tham s·ªë C√≥ th·ªÉ C·∫•u h√¨nh**: T·∫•t c·∫£ tham s·ªë th·ªùi gian v√† h√†nh vi c√≥ th·ªÉ c·∫•u h√¨nh th√¥ng qua c·∫•u h√¨nh UCI
- **X·ª≠ l√Ω L·ªói M·∫°nh m·∫Ω**: X·ª≠ l√Ω m·ªôt c√°ch duy√™n d√°ng c√°c ph·ª• thu·ªôc b·ªã thi·∫øu, v·∫•n ƒë·ªÅ m·∫°ng v√† thay ƒë·ªïi giao di·ªán
- **Ph·ª• thu·ªôc T·ªëi thi·ªÉu**: Ch·ªâ y√™u c·∫ßu ping v√† tc - kh√¥ng c·∫ßn g√≥i b·ªï sung, s·ª≠ d·ª•ng ti·ªán √≠ch t√≠ch h·ª£p c√≥ s·∫µn tr√™n t·∫•t c·∫£ h·ªá th·ªëng
- **RTT ƒê·ªô ch√≠nh x√°c Cao**: H·ªó tr·ª£ gi√° tr·ªã RTT ph√¢n s·ªë (v√≠ d·ª•: 100.23ms) ƒë·ªÉ ƒëi·ªÅu ch·ªânh th·ªùi gian m·∫°ng ch√≠nh x√°c

## üîß T∆∞∆°ng th√≠ch

**ƒê√£ ki·ªÉm tra v√† ho·∫°t ƒë·ªông:**
- **OpenWrt 24.10.1, r28597-0425664679, Target Platform x86/64**

**T∆∞∆°ng th√≠ch d·ª± ki·∫øn:**
- C√°c phi√™n b·∫£n OpenWrt tr∆∞·ªõc ƒë√≥ (21.02+) v·ªõi h·ªó tr·ª£ CAKE qdisc
- C√°c b·∫£n ph√°t h√†nh OpenWrt t∆∞∆°ng lai mi·ªÖn l√† c√°c ph·ª• thu·ªôc c·∫ßn thi·∫øt c√≥ s·∫µn
- T·∫•t c·∫£ ki·∫øn tr√∫c ƒë√≠ch ƒë∆∞·ª£c h·ªó tr·ª£ b·ªüi OpenWrt (ARM, MIPS, x86, v.v.)

**Y√™u c·∫ßu t∆∞∆°ng th√≠ch:**
- M√¥-ƒëun kernel CAKE qdisc
- Ti·ªán √≠ch ping (bao g·ªìm trong t·∫•t c·∫£ b·∫£n ph√¢n ph·ªëi Linux ti√™u chu·∫©n)
- Ti·ªán √≠ch tc ti√™u chu·∫©n (ki·ªÉm so√°t l∆∞u l∆∞·ª£ng)
- H·ªó tr·ª£ /proc/net/nf_conntrack (netfilter conntrack)

## üìã Y√™u c·∫ßu

### Ph·ª• thu·ªôc
- **ping**: Ti·ªán √≠ch ping ti√™u chu·∫©n ƒë·ªÉ ƒëo RTT (bao g·ªìm trong t·∫•t c·∫£ b·∫£n ph√¢n ph·ªëi Linux)
- **tc**: Ti·ªán √≠ch ki·ªÉm so√°t l∆∞u l∆∞·ª£ng (m·ªôt ph·∫ßn c·ªßa iproute2)
- **CAKE qdisc**: Ph·∫£i ƒë∆∞·ª£c c·∫•u h√¨nh tr√™n c√°c giao di·ªán ƒë√≠ch

### C√†i ƒë·∫∑t Ph·ª• thu·ªôc

```bash
# ping ƒë∆∞·ª£c bao g·ªìm theo m·∫∑c ƒë·ªãnh trong OpenWrt
# Kh√¥ng c·∫ßn g√≥i b·ªï sung cho ch·ª©c nƒÉng ping

# CAKE qdisc th∆∞·ªùng c√≥ s·∫µn trong c√°c phi√™n b·∫£n OpenWrt hi·ªán ƒë·∫°i
# Ki·ªÉm tra xem tc c√≥ h·ªó tr·ª£ CAKE kh√¥ng:
tc qdisc help | grep cake
```

## üîß C√†i ƒë·∫∑t

> [!IMPORTANT]  
> Tr∆∞·ªõc khi ch·∫°y script c√†i ƒë·∫∑t, b·∫°n PH·∫¢I ch·ªânh s·ª≠a t·ªáp c·∫•u h√¨nh ƒë·ªÉ ƒë·∫∑t t√™n giao di·ªán ch√≠nh x√°c cho h·ªá th·ªëng c·ªßa b·∫°n.

1. **Ch·ªânh s·ª≠a t·ªáp c·∫•u h√¨nh:**

```bash
# Ch·ªânh s·ª≠a t·ªáp c·∫•u h√¨nh ƒë·ªÉ ph√π h·ª£p v·ªõi t√™n giao di·ªán c·ªßa b·∫°n
nano etc/config/cake-autortt
```

2. **C·∫•u h√¨nh t√™n giao di·ªán c·ªßa b·∫°n:**

C·∫≠p nh·∫≠t c√†i ƒë·∫∑t `dl_interface` (download) v√† `ul_interface` (upload) ƒë·ªÉ ph√π h·ª£p v·ªõi thi·∫øt l·∫≠p m·∫°ng c·ªßa b·∫°n:

```bash
# V√≠ d·ª• c·∫•u h√¨nh cho c√°c thi·∫øt l·∫≠p kh√°c nhau:

# Cho thi·∫øt l·∫≠p OpenWrt SQM ƒëi·ªÉn h√¨nh s·ª≠ d·ª•ng giao di·ªán ifb:
option dl_interface 'ifb-wan'      # Giao di·ªán download (th∆∞·ªùng l√† ifb-*)
option ul_interface 'wan'          # Giao di·ªán upload (th∆∞·ªùng l√† wan, eth0, v.v.)

# Cho thi·∫øt l·∫≠p giao di·ªán tr·ª±c ti·∫øp:
option dl_interface 'eth0'         # Giao di·ªán WAN c·ªßa b·∫°n
option ul_interface 'eth0'         # C√πng giao di·ªán cho c·∫£ hai h∆∞·ªõng

# Cho t√™n giao di·ªán t√πy ch·ªânh:
option dl_interface 'ifb4eth1'     # Giao di·ªán download c·ª• th·ªÉ c·ªßa b·∫°n
option ul_interface 'eth1'         # Giao di·ªán upload c·ª• th·ªÉ c·ªßa b·∫°n
```

**C√°ch t√¨m t√™n giao di·ªán c·ªßa b·∫°n:**
```bash
# Li·ªát k√™ c√°c giao di·ªán v·ªõi CAKE qdisc
tc qdisc show | grep cake

# Li·ªát k√™ t·∫•t c·∫£ giao di·ªán m·∫°ng
ip link show

# Ki·ªÉm tra c·∫•u h√¨nh giao di·ªán SQM (n·∫øu s·ª≠ d·ª•ng SQM)
uci show sqm
```

### C√†i ƒë·∫∑t Nhanh

1. **C·∫•u h√¨nh giao di·ªán (xem ph·∫ßn tr√™n)**

2. **Ch·∫°y script c√†i ƒë·∫∑t:**

```bash
# L√†m cho script c√†i ƒë·∫∑t c√≥ th·ªÉ th·ª±c thi v√† ch·∫°y
chmod +x install.sh
./install.sh
```

### C√†i ƒë·∫∑t Th·ªß c√¥ng

1. **Sao ch√©p t·ªáp d·ªãch v·ª• v√†o router OpenWrt c·ªßa b·∫°n:**

```bash
# Sao ch√©p t·ªáp th·ª±c thi ch√≠nh
cp usr/bin/cake-autortt /usr/bin/
chmod +x /usr/bin/cake-autortt

# Sao ch√©p script kh·ªüi t·∫°o
cp etc/init.d/cake-autortt /etc/init.d/
chmod +x /etc/init.d/cake-autortt

# Sao ch√©p t·ªáp c·∫•u h√¨nh
cp etc/config/cake-autortt /etc/config/

# Sao ch√©p script hotplug
cp etc/hotplug.d/iface/99-cake-autortt /etc/hotplug.d/iface/
chmod +x /etc/hotplug.d/iface/99-cake-autortt
```

2. **K√≠ch ho·∫°t v√† kh·ªüi ƒë·ªông d·ªãch v·ª•:**

```bash
# K√≠ch ho·∫°t d·ªãch v·ª• ƒë·ªÉ kh·ªüi ƒë·ªông t·ª± ƒë·ªông khi boot
/etc/init.d/cake-autortt enable

# Kh·ªüi ƒë·ªông d·ªãch v·ª•
/etc/init.d/cake-autortt start
```

## üóëÔ∏è G·ª° c√†i ƒë·∫∑t

ƒê·ªÉ g·ª° cake-autortt kh·ªèi h·ªá th·ªëng c·ªßa b·∫°n:

```bash
# L√†m cho script g·ª° c√†i ƒë·∫∑t c√≥ th·ªÉ th·ª±c thi v√† ch·∫°y
chmod +x uninstall.sh
./uninstall.sh
```

Script g·ª° c√†i ƒë·∫∑t s·∫Ω:
- D·ª´ng v√† v√¥ hi·ªáu h√≥a d·ªãch v·ª•
- X√≥a t·∫•t c·∫£ t·ªáp ƒë√£ c√†i ƒë·∫∑t
- T√πy ch·ªçn x√≥a t·ªáp c·∫•u h√¨nh v√† sao l∆∞u
- D·ªçn d·∫πp t·ªáp t·∫°m th·ªùi

## ‚öôÔ∏è C·∫•u h√¨nh

### üîß C·∫•u h√¨nh Giao di·ªán (B·∫ÆT BU·ªòC)

**B∆∞·ªõc c·∫•u h√¨nh quan tr·ªçng nh·∫•t l√† ƒë·∫∑t t√™n giao di·ªán ch√≠nh x√°c.** D·ªãch v·ª• s·∫Ω kh√¥ng ho·∫°t ƒë·ªông ƒë√∫ng c√°ch m√† kh√¥ng c√≥ t√™n giao di·ªán ch√≠nh x√°c.

```bash
# Xem c·∫•u h√¨nh hi·ªán t·∫°i
uci show cake-autortt

# B·∫ÆT BU·ªòC: ƒê·∫∑t t√™n giao di·ªán c·ªßa b·∫°n
uci set cake-autortt.global.dl_interface='your-download-interface'
uci set cake-autortt.global.ul_interface='your-upload-interface'
uci commit cake-autortt

# C√°c thay ƒë·ªïi c·∫•u h√¨nh t√πy ch·ªçn kh√°c
uci set cake-autortt.global.rtt_update_interval='30'
uci set cake-autortt.global.debug='1'
uci commit cake-autortt

# Kh·ªüi ƒë·ªông l·∫°i d·ªãch v·ª• ƒë·ªÉ √°p d·ª•ng thay ƒë·ªïi
/etc/init.d/cake-autortt restart
```

D·ªãch v·ª• ƒë∆∞·ª£c c·∫•u h√¨nh th√¥ng qua UCI. Ch·ªânh s·ª≠a `/etc/config/cake-autortt` ho·∫∑c s·ª≠ d·ª•ng l·ªánh `uci`.

### Tham s·ªë C·∫•u h√¨nh

| Tham s·ªë | M·∫∑c ƒë·ªãnh | M√¥ t·∫£ |
|-----------|---------|-------------|
| `dl_interface` | auto | T√™n giao di·ªán download (v√≠ d·ª•: 'ifb-wan', 'ifb4eth1') |
| `ul_interface` | auto | T√™n giao di·ªán upload (v√≠ d·ª•: 'wan', 'eth1') |
| `rtt_update_interval` | 5 | Gi√¢y gi·ªØa c√°c l·∫ßn c·∫≠p nh·∫≠t tham s·ªë qdisc RTT |
| `min_hosts` | 3 | S·ªë l∆∞·ª£ng host t·ªëi thi·ªÉu c·∫ßn thi·∫øt ƒë·ªÉ t√≠nh to√°n RTT |
| `max_hosts` | 100 | S·ªë l∆∞·ª£ng host t·ªëi ƒëa ƒë·ªÉ thƒÉm d√≤ tu·∫ßn t·ª± |
| `rtt_margin_percent` | 10 | L·ªÅ an to√†n ƒë∆∞·ª£c th√™m v√†o RTT ƒëo ƒë∆∞·ª£c (ph·∫ßn trƒÉm) |
| `default_rtt_ms` | 100 | RTT m·∫∑c ƒë·ªãnh khi kh√¥ng c√≥ ƒë·ªß host kh·∫£ d·ª•ng |
| `debug` | 0 | K√≠ch ho·∫°t ghi log debug (0=t·∫Øt, 1=b·∫≠t) |

> [!NOTE]  
> M·∫∑c d√π c√°c tham s·ªë giao di·ªán c√≥ m·∫∑c ƒë·ªãnh "auto", ph√°t hi·ªán t·ª± ƒë·ªông c√≥ th·ªÉ kh√¥ng ho·∫°t ƒë·ªông ƒë√°ng tin c·∫≠y trong t·∫•t c·∫£ c·∫•u h√¨nh. Khuy·∫øn kh√≠ch m·∫°nh m·∫Ω ƒë·∫∑t c√°c gi√° tr·ªã n√†y m·ªôt c√°ch r√µ r√†ng.

> [!TIP]  
> ƒê·ªëi v·ªõi m·∫°ng ho·∫°t ƒë·ªông cao (v√≠ d·ª•: khu√¥n vi√™n ƒë·∫°i h·ªçc, m·∫°ng c√¥ng c·ªông v·ªõi nhi·ªÅu ng∆∞·ªùi d√πng ho·∫°t ƒë·ªông), h√£y xem x√©t ƒëi·ªÅu ch·ªânh `rtt_update_interval` d·ª±a tr√™n ƒë·∫∑c ƒëi·ªÉm m·∫°ng c·ªßa b·∫°n. M·∫∑c ƒë·ªãnh 5 gi√¢y ho·∫°t ƒë·ªông t·ªët cho h·∫ßu h·∫øt c√°c t√¨nh hu·ªëng, nh∆∞ng b·∫°n c√≥ th·ªÉ tƒÉng l√™n 10-15 gi√¢y cho m·∫°ng ·ªïn ƒë·ªãnh h∆°n ho·∫∑c gi·∫£m xu·ªëng 3 gi√¢y cho m√¥i tr∆∞·ªùng r·∫•t ƒë·ªông.

## üîç C√°ch ho·∫°t ƒë·ªông

1. **Gi√°m s√°t K·∫øt n·ªëi**: ƒê·ªãnh k·ª≥ ph√¢n t√≠ch `/proc/net/nf_conntrack` ƒë·ªÉ x√°c ƒë·ªãnh c√°c k·∫øt n·ªëi m·∫°ng ho·∫°t ƒë·ªông
2. **L·ªçc Host**: Tr√≠ch xu·∫•t ƒë·ªãa ch·ªâ IP ƒë√≠ch v√† l·ªçc ƒë·ªãa ch·ªâ ri√™ng t∆∞/LAN
3. **ƒêo RTT**: S·ª≠ d·ª•ng `ping` ƒë·ªÉ ƒëo RTT c·ªßa t·ª´ng host b√™n ngo√†i ri√™ng l·∫ª (3 ping m·ªói host)
4. **L·ª±a ch·ªçn RTT Th√¥ng minh**: Ping c√°c host tu·∫ßn t·ª± ƒë·ªÉ ngƒÉn t·∫Øc ngh·∫Ωn m·∫°ng, t√≠nh to√°n RTT trung b√¨nh v√† t·ªá nh·∫•t, sau ƒë√≥ s·ª≠ d·ª•ng gi√° tr·ªã cao h∆°n ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªáu su·∫•t t·ªëi ∆∞u cho t·∫•t c·∫£ k·∫øt n·ªëi
5. **L·ªÅ An to√†n**: Th√™m l·ªÅ c√≥ th·ªÉ c·∫•u h√¨nh v√†o RTT ƒëo ƒë∆∞·ª£c ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªám ƒë·∫ßy ƒë·ªß
6. **C·∫≠p nh·∫≠t qdisc**: C·∫≠p nh·∫≠t tham s·ªë CAKE qdisc RTT tr√™n giao di·ªán download v√† upload

### üß† Thu·∫≠t to√°n RTT Th√¥ng minh

K·ªÉ t·ª´ phi√™n b·∫£n 1.2.0, cake-autortt tri·ªÉn khai thu·∫≠t to√°n l·ª±a ch·ªçn RTT th√¥ng minh d·ª±a tr√™n khuy·∫øn ngh·ªã c·ªßa Dave T√§ht (ƒë·ªìng t√°c gi·∫£ CAKE):

**V·∫•n ƒë·ªÅ**: Ch·ªâ s·ª≠ d·ª•ng RTT trung b√¨nh c√≥ th·ªÉ c√≥ v·∫•n ƒë·ªÅ khi m·ªôt s·ªë host c√≥ ƒë·ªô tr·ªÖ cao h∆°n ƒë√°ng k·ªÉ so v·ªõi nh·ªØng host kh√°c. V√≠ d·ª•, n·∫øu b·∫°n c√≥ 100 host v·ªõi RTT trung b√¨nh 40ms, nh∆∞ng 2 host c√≥ RTT 234ms v√† 240ms, vi·ªác s·ª≠ d·ª•ng trung b√¨nh 40ms c√≥ th·ªÉ g√¢y ra v·∫•n ƒë·ªÅ hi·ªáu su·∫•t cho nh·ªØng k·∫øt n·ªëi ƒë·ªô tr·ªÖ cao n√†y.

**Gi·∫£i ph√°p**: Thu·∫≠t to√°n hi·ªán t·∫°i:
1. **T√≠nh to√°n c·∫£ RTT trung b√¨nh v√† t·ªá nh·∫•t** t·ª´ t·∫•t c·∫£ host ph·∫£n h·ªìi
2. **So s√°nh hai gi√° tr·ªã** v√† th√¥ng minh l·ª±a ch·ªçn gi√° tr·ªã ph√π h·ª£p
3. **S·ª≠ d·ª•ng RTT t·ªá nh·∫•t khi n√≥ cao h∆°n ƒë√°ng k·ªÉ** so v·ªõi trung b√¨nh ƒë·ªÉ ƒë·∫£m b·∫£o t·∫•t c·∫£ k·∫øt n·ªëi ho·∫°t ƒë·ªông t·ªët
4. **S·ª≠ d·ª•ng RTT trung b√¨nh khi RTT t·ªá nh·∫•t g·∫ßn** v·ªõi trung b√¨nh ƒë·ªÉ tr√°nh c√†i ƒë·∫∑t qu√° b·∫£o th·ªß

**T·∫°i sao ƒëi·ªÅu n√†y quan tr·ªçng**: Theo [Dave T√§ht](https://forum.mikrotik.com/t/fq-codel-cake-stories/181067/17), "t·ªët h∆°n, ƒë·∫∑c bi·ªát v·ªõi shaping ƒë·∫øn, l√† s·ª≠ d·ª•ng RTT ƒëi·ªÉn h√¨nh c·ªßa b·∫°n nh∆∞ m·ªôt ∆∞·ªõc t√≠nh ƒë·ªÉ c√≥ ƒë∆∞·ª£c ki·ªÉm so√°t h√†ng ƒë·ª£i tr∆∞·ªõc khi n√≥ ƒë·∫øn shaper ISP m√† b·∫°n ƒëang ƒë√°nh b·∫°i." Tuy nhi√™n, n·∫øu RTT th·ª±c t·∫ø ƒë·∫øn b·∫•t k·ª≥ host n√†o d√†i h∆°n RTT ƒë∆∞·ª£c ƒë·∫∑t tr√™n giao di·ªán CAKE, hi·ªáu su·∫•t c√≥ th·ªÉ b·ªã ·∫£nh h∆∞·ªüng ƒë√°ng k·ªÉ.

**V√≠ d·ª• th·ª±c t·∫ø**:
- 98 host v·ªõi RTT 30-50ms (trung b√¨nh: 42ms)
- 2 host v·ªõi RTT 200ms+ (t·ªá nh·∫•t: 234ms)
- **Thu·∫≠t to√°n c≈©**: S·∫Ω s·ª≠ d·ª•ng trung b√¨nh 45ms, g√¢y ra v·∫•n ƒë·ªÅ cho host 200ms+
- **Thu·∫≠t to√°n m·ªõi**: S·ª≠ d·ª•ng RTT t·ªá nh·∫•t 234ms, ƒë·∫£m b·∫£o hi·ªáu su·∫•t t·ªëi ∆∞u cho t·∫•t c·∫£ k·∫øt n·ªëi

### V√≠ d·ª• Lu·ªìng K·∫øt n·ªëi

```
[Thi·∫øt b·ªã LAN] ‚Üí [Router CAKE] ‚Üí [Internet]
                       ‚Üë
                 cake-autortt gi√°m s√°t
                 k·∫øt n·ªëi ho·∫°t ƒë·ªông v√†
                 ƒëi·ªÅu ch·ªânh tham s·ªë RTT
```

## üìä H√†nh vi D·ª± ki·∫øn

Sau khi c√†i ƒë·∫∑t v√† kh·ªüi ƒë·ªông, b·∫°n n√™n quan s√°t:

### Hi·ªáu ·ª©ng Ngay l·∫≠p t·ª©c
- D·ªãch v·ª• kh·ªüi ƒë·ªông t·ª± ƒë·ªông v√† b·∫Øt ƒë·∫ßu gi√°m s√°t k·∫øt n·ªëi
- C√°c ph√©p ƒëo RTT ƒë∆∞·ª£c ghi v√†o log h·ªá th·ªëng (n·∫øu debug ƒë∆∞·ª£c b·∫≠t)
- Tham s·ªë CAKE qdisc RTT ƒë∆∞·ª£c c·∫≠p nh·∫≠t m·ªói 30 gi√¢y d·ª±a tr√™n ƒëi·ªÅu ki·ªán m·∫°ng ƒëo ƒë∆∞·ª£c
- Gi√° tr·ªã RTT ƒë·ªô ch√≠nh x√°c cao (v√≠ d·ª•: 44.89ms) ƒë∆∞·ª£c √°p d·ª•ng cho CAKE qdisc

### L·ª£i √≠ch D√†i h·∫°n
- **C·∫£i thi·ªán Ph·∫£n h·ªìi**: Tham s·ªë RTT lu√¥n c·∫≠p nh·∫≠t v·ªõi ƒëi·ªÅu ki·ªán m·∫°ng th·ª±c t·∫ø
- **Ki·ªÉm so√°t Bufferbloat T·ªët h∆°n**: CAKE c√≥ th·ªÉ ƒë∆∞a ra quy·∫øt ƒë·ªãnh qu·∫£n l√Ω h√†ng ƒë·ª£i c√≥ th√¥ng tin h∆°n
- **Hi·ªáu su·∫•t Th√≠ch ·ª©ng**: T·ª± ƒë·ªông th√≠ch ·ª©ng v·ªõi ƒëi·ªÅu ki·ªán m·∫°ng thay ƒë·ªïi (v·ªá tinh, di ƒë·ªông, li√™n k·∫øt t·∫Øc ngh·∫Ωn)
- **ƒê·ªô ch√≠nh x√°c Cao h∆°n**: L·∫•y m·∫´u l√™n ƒë·∫øn 20 host ƒë·ªÉ ƒë·∫°i di·ªán t·ªët h∆°n cho ƒëi·ªÅu ki·ªán m·∫°ng

### Gi√°m s√°t

```bash
# Ki·ªÉm tra tr·∫°ng th√°i d·ªãch v·ª•
/etc/init.d/cake-autortt status

# Xem log d·ªãch v·ª•
logread | grep cake-autortt

# Gi√°m s√°t tham s·ªë CAKE qdisc
tc qdisc show | grep cake

# Ch·∫ø ƒë·ªô debug cho log chi ti·∫øt
uci set cake-autortt.global.debug='1'
uci commit cake-autortt
/etc/init.d/cake-autortt restart
```

## üîß Kh·∫Øc ph·ª•c s·ª± c·ªë

### V·∫•n ƒë·ªÅ Th∆∞·ªùng g·∫∑p

1. **D·ªãch v·ª• kh√¥ng kh·ªüi ƒë·ªông**
   ```bash
   # Ki·ªÉm tra ph·ª• thu·ªôc
   which ping tc
   
   # Ki·ªÉm tra giao di·ªán CAKE
   tc qdisc show | grep cake
   ```

2. **Kh√¥ng c√≥ c·∫≠p nh·∫≠t RTT**
   ```bash
   # B·∫≠t ch·∫ø ƒë·ªô debug
   uci set cake-autortt.global.debug='1'
   uci commit cake-autortt
   /etc/init.d/cake-autortt restart
   
   # Ki·ªÉm tra log
   logread | grep cake-autortt
   ```

3. **Ph√°t hi·ªán giao di·ªán th·∫•t b·∫°i**
   ```bash
   # Ch·ªâ ƒë·ªãnh giao di·ªán th·ªß c√¥ng
   uci set cake-autortt.global.dl_interface='ifb-wan'
   uci set cake-autortt.global.ul_interface='wan'
   uci commit cake-autortt
   /etc/init.d/cake-autortt restart
   ```

### Th√¥ng tin Debug

V·ªõi debug ƒë∆∞·ª£c b·∫≠t (`uci set cake-autortt.global.debug='1'`), d·ªãch v·ª• cung c·∫•p log chi ti·∫øt:

**V√≠ d·ª• ƒë·∫ßu ra debug:**
```bash
[2025-01-09 18:34:22] cake-autortt DEBUG: Tr√≠ch xu·∫•t host t·ª´ conntrack
[2025-01-09 18:34:22] cake-autortt DEBUG: T√¨m th·∫•y 35 host kh√¥ng ph·∫£i LAN
[2025-01-09 18:34:22] cake-autortt DEBUG: ƒêo RTT b·∫±ng ping cho 35 host (3 ping m·ªói host)
[2025-01-09 18:34:25] cake-autortt DEBUG: t√≥m t·∫Øt ping: 28/35 host s·ªëng
[2025-01-09 18:34:25] cake-autortt DEBUG: S·ª≠ d·ª•ng RTT trung b√¨nh: 45.2ms (trung b√¨nh: 45.2ms, t·ªá nh·∫•t: 89.1ms)
[2025-01-09 18:34:25] cake-autortt DEBUG: S·ª≠ d·ª•ng RTT ƒëo ƒë∆∞·ª£c: 45.2ms
[2025-01-09 18:34:35] cake-autortt INFO: ƒê·∫∑t CAKE RTT th√†nh 49.72ms (49720us)
[2025-01-09 18:34:35] cake-autortt DEBUG: RTT ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr√™n giao di·ªán download ifb-wan
[2025-01-09 18:34:35] cake-autortt DEBUG: RTT ƒë∆∞·ª£c c·∫≠p nh·∫≠t tr√™n giao di·ªán upload wan
```

> [!NOTE]  
> **Log Hi·ªáu qu·∫£ B·ªô nh·ªõ**: Log debug ƒë∆∞·ª£c t·ªëi ∆∞u h√≥a ƒë·ªÉ ngƒÉn tr√†n log. C√°c ph√©p ƒëo RTT host ri√™ng l·∫ª kh√¥ng ƒë∆∞·ª£c ghi ƒë·ªÉ gi·∫£m s·ª≠ d·ª•ng b·ªô nh·ªõ v√† ghi ƒëƒ©a. Ch·ªâ th√¥ng tin t√≥m t·∫Øt ƒë∆∞·ª£c ghi, l√†m cho n√≥ ph√π h·ª£p cho ho·∫°t ƒë·ªông li√™n t·ª•c m√† kh√¥ng tƒÉng tr∆∞·ªüng log qu√° m·ª©c.

## üìÑ Gi·∫•y ph√©p

D·ª± √°n n√†y ƒë∆∞·ª£c c·∫•p ph√©p theo GNU General Public License v2.0 - xem t·ªáp [LICENSE](LICENSE) ƒë·ªÉ bi·∫øt chi ti·∫øt.

## ü§ù ƒê√≥ng g√≥p

Ch√†o m·ª´ng ƒë√≥ng g√≥p! Vui l√≤ng g·ª≠i Pull Request.