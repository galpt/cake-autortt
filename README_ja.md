# cake-autortt

## 🌐 Language / 语言 / Bahasa / Язык / 言語 / Ngôn ngữ / Dil / اللغة

[English](README.md) | [中文](README_zh.md) | [Bahasa Indonesia](README_id.md) | [Русский](README_ru.md) | **日本語** | [Tiếng Việt](README_vi.md) | [Türkçe](README_tr.md) | [العربية](README_ar.md)

---

> [!NOTE]  
> **Ubuntu/Debian版**をお探しの場合は、`ubuntu-debian/`フォルダをご確認ください。ただし、OpenWrt版のみが個人的に毎日テストされており、Ubuntu/Debian移植版はコミュニティ向けにそのまま提供されていることにご注意ください。

**測定されたネットワーク状況に基づいてCAKE qdiscのRTTパラメータを自動調整します**

`cake-autortt`は、アクティブなネットワーク接続をインテリジェントに監視し、最適なネットワークパフォーマンスのために受信および送信インターフェースのCAKE qdiscのRTT（Round Trip Time）パラメータを自動調整するOpenWrtサービスです。

## 🌍 なぜこれがあなたのインターネット体験にとって重要なのか

ほとんどのユーザーは、YouTube、Netflix、Googleなどの主要なウェブサイトの高速読み込み時間に慣れています。これらのサイトは、ユーザーの非常に近くにサーバーを配置するコンテンツ配信ネットワーク（CDN）を使用しており、通常50-100msの応答時間を提供しています。しかし、インターネットはこれらの大手プラットフォームよりもはるかに大きいものです。

**CDNでサポートされている主要サイト以外のサイトを閲覧すると、多様なサーバーの世界に遭遇します：**
- **ローカル/地域サービス**：中小企業、地元ニュースサイト、コミュニティフォーラム、地域サービスは、多くの場合あなたの国や地域にサーバーを持っています（10-50ms RTT）
- **国際コンテンツ**：専門ウェブサイト、学術リソース、ゲームサーバー、ニッチサービスは他の大陸でホストされている可能性があります（100-500ms RTT）
- **リモートインフラストラクチャ**：一部のサービス、特に発展途上地域や専門アプリケーションでは、大幅に高い遅延を持つ場合があります

**CAKE RTTパラメータは、キューイングアルゴリズムが輻輳にどれだけ積極的に反応するかを制御します。** デフォルトでは、CAKEは100msのRTT仮定を使用し、これは一般的なインターネットトラフィックに対してかなりうまく機能します。しかし：

- **RTT設定が低すぎる場合**：CAKEがネットワークRTTが実際よりも短いと考えると、キューシェーピング時にパケットドロップが過度に積極的になり、リモートサーバーの帯域幅が低下する可能性があります
- **RTT設定が高すぎる場合**：CAKEがネットワークRTTが実際よりも長いと考えると、過度に保守的になり、大きなキューの形成を許可し、近くのサーバーに不要な遅延を作成します

**実世界の影響例：**
- **シンガポールのユーザー → ドイツのサーバー**：RTT調整なしでは、シンガポールのユーザーがドイツのウェブサイト（≈180ms RTT）にアクセスする際、CAKEのデフォルト100ms設定が早期パケットドロップを引き起こすため、帯域幅の低下を経験する可能性があります
- **米国の農村部 → 地域サーバー**：米国の農村部のユーザーが地域サーバー（≈25ms RTT）にアクセスする際、CAKEのデフォルト100ms設定が必要以上にキューの成長を許可するため、必要以上に高い遅延を経験する可能性があります
- **ゲーム/リアルタイムアプリケーション**：遅延と帯域幅の両方に敏感なアプリケーションは、実際のネットワーク状況に一致するRTT調整から大幅に恩恵を受けます

**cake-autorttの支援方法：**
通信している実際のサーバーへの実際のRTTを自動測定し、それに応じてCAKEパラメータを調整することで、以下を得られます：
- 近くのサーバーアクセス時の**より高速な応答性**（短いRTT → より積極的なキュー管理）
- リモートサーバーアクセス時の**より良い帯域幅**（長いRTT → より忍耐強いキュー管理）
- 仮定ではなく実際のネットワーク状況に適応する**最適なbufferbloat制御**

これは、多様なコンテンツソースに定期的にアクセスしたり、国際サービスで作業したり、インターネットトラフィックが頻繁に長距離を移動する地域に住んでいるユーザーにとって特に価値があります。

## 🚀 機能

- **自動RTT検出**：`/proc/net/nf_conntrack`を通じてアクティブな接続を監視し、外部ホストへのRTTを測定
- **スマートホストフィルタリング**：LANアドレスを自動フィルタリングし、外部ホストに焦点を当てる
- **スマートRTTアルゴリズム**：組み込みpingコマンドを使用して各ホストのRTTを個別に測定（ホストあたり3回のping）、その後平均と最悪のRTTの間でインテリジェントに選択して最適なパフォーマンスを実現
- **自動インターフェース検出**：CAKE対応インターフェースを自動検出（ダウンロードには`ifb-*`を優先、アップロードには物理インターフェースを優先）
- **OpenWrtサービス統合**：自動起動とプロセス管理を備えた適切なOpenWrtサービスとして動作
- **設定可能なパラメータ**：すべてのタイミングと動作パラメータはUCI設定を通じて設定可能
- **堅牢なエラー処理**：依存関係の欠如、ネットワーク問題、インターフェース変更を優雅に処理
- **最小限の依存関係**：pingとtcのみが必要 - 追加パッケージは不要、すべてのシステムで利用可能な組み込みユーティリティを使用
- **高精度RTT**：正確なネットワークタイミング調整のために小数RTT値（例：100.23ms）をサポート

## 🔧 互換性

**テスト済みで動作確認：**
- **OpenWrt 24.10.1, r28597-0425664679, Target Platform x86/64**

**期待される互換性：**
- CAKE qdiscサポートを持つ以前のOpenWrtバージョン（21.02+）
- 必要な依存関係が利用可能である限りの将来のOpenWrtリリース
- OpenWrtでサポートされているすべてのターゲットアーキテクチャ（ARM、MIPS、x86など）

**互換性要件：**
- CAKEカーネルモジュール
- pingユーティリティ（すべての標準Linuxディストリビューションに含まれる）
- 標準tcユーティリティ（トラフィック制御）
- /proc/net/nf_conntrackサポート（netfilter conntrack）

## 📋 要件

### 依存関係
- **ping**：RTT測定用の標準pingユーティリティ（すべてのLinuxディストリビューションに含まれる）
- **tc**：トラフィック制御ユーティリティ（iproute2の一部）
- **CAKE qdisc**：ターゲットインターフェースで設定されている必要があります

### 依存関係のインストール

```bash
# pingはOpenWrtにデフォルトで含まれています
# ping機能のための追加パッケージは必要ありません

# CAKE qdiscは通常、現代のOpenWrtバージョンで利用可能です
# tcがCAKEをサポートしているかチェック：
tc qdisc help | grep cake
```

## 🔧 インストール

> [!IMPORTANT]  
> インストールスクリプトを実行する前に、システムの正しいインターフェース名を設定するために設定ファイルを編集する必要があります。

1. **設定ファイルを編集：**

```bash
# インターフェース名に合わせて設定ファイルを編集
nano etc/config/cake-autortt
```

2. **インターフェース名を設定：**

ネットワーク設定に合わせて`dl_interface`（ダウンロード）と`ul_interface`（アップロード）設定を更新：

```bash
# 異なる設定の設定例：

# ifbインターフェースを使用する典型的なOpenWrt SQM設定の場合：
option dl_interface 'ifb-wan'      # ダウンロードインターフェース（通常ifb-*）
option ul_interface 'wan'          # アップロードインターフェース（通常wan、eth0など）

# 直接インターフェース設定の場合：
option dl_interface 'eth0'         # あなたのWANインターフェース
option ul_interface 'eth0'         # 両方向で同じインターフェース

# カスタムインターフェース名の場合：
option dl_interface 'ifb4eth1'     # あなたの特定のダウンロードインターフェース
option ul_interface 'eth1'         # あなたの特定のアップロードインターフェース
```

**インターフェース名を見つける方法：**
```bash
# CAKE qdiscを持つインターフェースをリスト
tc qdisc show | grep cake

# すべてのネットワークインターフェースをリスト
ip link show

# SQMインターフェース設定をチェック（SQMを使用している場合）
uci show sqm
```

### クイックインストール

1. **インターフェースを設定（上記セクションを参照）**

2. **インストールスクリプトを実行：**

```bash
# インストールスクリプトを実行可能にして実行
chmod +x install.sh
./install.sh
```

### 手動インストール

1. **サービスファイルをOpenWrtルーターにコピー：**

```bash
# メイン実行ファイルをコピー
cp usr/bin/cake-autortt /usr/bin/
chmod +x /usr/bin/cake-autortt

# 初期化スクリプトをコピー
cp etc/init.d/cake-autortt /etc/init.d/
chmod +x /etc/init.d/cake-autortt

# 設定ファイルをコピー
cp etc/config/cake-autortt /etc/config/

# hotplugスクリプトをコピー
cp etc/hotplug.d/iface/99-cake-autortt /etc/hotplug.d/iface/
chmod +x /etc/hotplug.d/iface/99-cake-autortt
```

2. **サービスを有効化して開始：**

```bash
# ブート時の自動起動のためにサービスを有効化
/etc/init.d/cake-autortt enable

# サービスを開始
/etc/init.d/cake-autortt start
```

## 🗑️ アンインストール

システムからcake-autorttを削除するには：

```bash
# アンインストールスクリプトを実行可能にして実行
chmod +x uninstall.sh
./uninstall.sh
```

アンインストールスクリプトは：
- サービスを停止して無効化
- インストールされたすべてのファイルを削除
- オプションで設定ファイルとバックアップファイルを削除
- 一時ファイルをクリーンアップ

## ⚙️ 設定

### 🔧 インターフェース設定（必須）

**最も重要な設定ステップは正しいインターフェース名の設定です。** 正しいインターフェース名なしではサービスは正常に動作しません。

```bash
# 現在の設定を表示
uci show cake-autortt

# 必須：インターフェース名を設定
uci set cake-autortt.global.dl_interface='your-download-interface'
uci set cake-autortt.global.ul_interface='your-upload-interface'
uci commit cake-autortt

# その他のオプション設定変更
uci set cake-autortt.global.rtt_update_interval='30'
uci set cake-autortt.global.debug='1'
uci commit cake-autortt

# 変更を適用するためにサービスを再起動
/etc/init.d/cake-autortt restart
```

サービスはUCIを通じて設定されます。`/etc/config/cake-autortt`を編集するか、`uci`コマンドを使用してください。

### 設定パラメータ

| パラメータ | デフォルト | 説明 |
|-----------|---------|-------------|
| `dl_interface` | auto | ダウンロードインターフェース名（例：'ifb-wan'、'ifb4eth1'） |
| `ul_interface` | auto | アップロードインターフェース名（例：'wan'、'eth1'） |
| `rtt_update_interval` | 5 | qdisc RTTパラメータ更新間隔（秒） |
| `min_hosts` | 3 | RTT計算に必要な最小ホスト数 |
| `max_hosts` | 100 | 順次プローブする最大ホスト数 |
| `rtt_margin_percent` | 10 | 測定RTTに追加される安全マージン（パーセント） |
| `default_rtt_ms` | 100 | 十分なホストが利用できない場合のデフォルトRTT |
| `debug` | 0 | デバッグログを有効化（0=無効、1=有効） |

> [!NOTE]  
> インターフェースパラメータはデフォルトで"auto"ですが、自動検出はすべての設定で確実に動作するとは限りません。これらの値を明示的に設定することを強く推奨します。

> [!TIP]  
> 高活動ネットワーク（例：大学キャンパス、多くのアクティブユーザーを持つパブリックネットワーク）の場合、ネットワーク特性に基づいて`rtt_update_interval`の調整を検討してください。デフォルトの5秒はほとんどのシナリオでうまく機能しますが、より安定したネットワークでは10-15秒に増やしたり、非常に動的な環境では3秒に減らしたりできます。

## 🔍 動作原理

1. **接続監視**：`/proc/net/nf_conntrack`を定期的に解析してアクティブなネットワーク接続を特定
2. **ホストフィルタリング**：宛先IPアドレスを抽出し、プライベート/LANアドレスをフィルタリング
3. **RTT測定**：`ping`を使用して各外部ホストのRTTを個別に測定（ホストあたり3回のping）
4. **スマートRTT選択**：ネットワーク輻輳を防ぐためにホストを順次ping、平均と最悪のRTTを計算し、すべての接続の最適なパフォーマンスを確保するためにより高い値を使用
5. **安全マージン**：適切なバッファリングを確保するために測定RTTに設定可能なマージンを追加
6. **qdisc更新**：ダウンロードとアップロードインターフェースのCAKE qdisc RTTパラメータを更新

### 🧠 スマートRTTアルゴリズム

バージョン1.2.0以降、cake-autorttはDave Täht（CAKEの共同作成者）の推奨に基づくインテリジェントRTT選択アルゴリズムを実装しています：

**問題**：平均RTTのみを使用することは、一部のホストが他のホストよりも大幅に高い遅延を持つ場合に問題となる可能性があります。例えば、平均RTT 40msの100ホストがあるが、2ホストが234msと240msのRTTを持つ場合、平均40msを使用すると、これらの高遅延接続でパフォーマンス問題が発生する可能性があります。

**解決策**：アルゴリズムは現在：
1. **すべての応答ホストから平均と最悪の両方のRTTを計算**
2. **2つの値を比較**し、適切なものをインテリジェントに選択
3. **最悪のRTTが平均より大幅に高い場合は最悪のRTTを使用**して、すべての接続が良好に動作することを確保
4. **最悪のRTTが平均に近い場合は平均RTTを使用**して、過度に保守的な設定を避ける

**なぜこれが重要か**：[Dave Täht](https://forum.mikrotik.com/t/fq-codel-cake-stories/181067/17)によると、「特に受信シェーピングでは、ISPシェーパーに到達する前にキュー制御を取得するために、典型的なRTTを推定として使用する方が良い。」しかし、任意のホストへの実際のRTTがCAKEインターフェースで設定されたRTTより長い場合、パフォーマンスが大幅に低下する可能性があります。

**実世界の例**：
- 98ホストが30-50ms RTT（平均：42ms）
- 2ホストが200ms+ RTT（最悪：234ms）
- **旧アルゴリズム**：平均45msを使用し、200ms+ホストで問題を引き起こす
- **新アルゴリズム**：最悪RTT 234msを使用し、すべての接続で最適なパフォーマンスを確保

### 接続フローの例

```
[LANデバイス] → [CAKEルーター] → [インターネット]
                       ↑
                 cake-autorttが
                 アクティブな接続を監視し
                 RTTパラメータを調整
```

## 📊 期待される動作

インストールと起動後、以下を観察できるはずです：

### 即座の効果
- サービスが自動的に起動し、接続の監視を開始
- RTT測定がシステムログに記録される（デバッグが有効な場合）
- 測定されたネットワーク状況に基づいて30秒ごとにCAKE qdisc RTTパラメータが更新される
- 高精度RTT値（例：44.89ms）がCAKE qdiscに適用される

### 長期的な利点
- **改善された応答性**：RTTパラメータが実際のネットワーク状況と最新の状態を保つ
- **より良いBufferbloat制御**：CAKEがキュー管理についてより情報に基づいた決定を行える
- **適応的パフォーマンス**：変化するネットワーク状況（衛星、セルラー、輻輳リンク）に自動的に適応
- **より高い精度**：より良いネットワーク状況の表現のために最大20ホストをサンプリング

### 監視

```bash
# サービスステータスをチェック
/etc/init.d/cake-autortt status

# サービスログを表示
logread | grep cake-autortt

# CAKE qdiscパラメータを監視
tc qdisc show | grep cake

# 詳細ログのためのデバッグモード
uci set cake-autortt.global.debug='1'
uci commit cake-autortt
/etc/init.d/cake-autortt restart
```

## 🔧 トラブルシューティング

### 一般的な問題

1. **サービスが起動しない**
   ```bash
   # 依存関係をチェック
   which ping tc
   
   # CAKEインターフェースをチェック
   tc qdisc show | grep cake
   ```

2. **RTT更新がない**
   ```bash
   # デバッグモードを有効化
   uci set cake-autortt.global.debug='1'
   uci commit cake-autortt
   /etc/init.d/cake-autortt restart
   
   # ログをチェック
   logread | grep cake-autortt
   ```

3. **インターフェース検出が失敗**
   ```bash
   # インターフェースを手動指定
   uci set cake-autortt.global.dl_interface='ifb-wan'
   uci set cake-autortt.global.ul_interface='wan'
   uci commit cake-autortt
   /etc/init.d/cake-autortt restart
   ```

### デバッグ情報

デバッグが有効（`uci set cake-autortt.global.debug='1'`）の場合、サービスは詳細なログを提供します：

**デバッグ出力例：**
```bash
[2025-01-09 18:34:22] cake-autortt DEBUG: conntrackからホストを抽出
[2025-01-09 18:34:22] cake-autortt DEBUG: 35の非LANホストを発見
[2025-01-09 18:34:22] cake-autortt DEBUG: 35ホストのpingでRTT測定（各3ping）
[2025-01-09 18:34:25] cake-autortt DEBUG: ping要約：28/35ホストが生存
[2025-01-09 18:34:25] cake-autortt DEBUG: 平均RTTを使用：45.2ms（平均：45.2ms、最悪：89.1ms）
[2025-01-09 18:34:25] cake-autortt DEBUG: 測定RTTを使用：45.2ms
[2025-01-09 18:34:35] cake-autortt INFO: CAKE RTTを49.72ms（49720us）に設定
[2025-01-09 18:34:35] cake-autortt DEBUG: ダウンロードインターフェースifb-wanでRTT更新
[2025-01-09 18:34:35] cake-autortt DEBUG: アップロードインターフェースwanでRTT更新
```

> [!NOTE]  
> **メモリ効率的なログ**：デバッグログはログの氾濫を防ぐために最適化されています。個別のホストRTT測定はメモリ使用量とディスク書き込みを削減するために記録されません。要約情報のみが記録され、過度なログ成長なしに継続的な操作に適しています。

## 📄 ライセンス

このプロジェクトはGNU General Public License v2.0の下でライセンスされています - 詳細は[LICENSE](LICENSE)ファイルを参照してください。

## 🤝 貢献

貢献を歓迎します！お気軽にPull Requestを送信してください。