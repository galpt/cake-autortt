# cake-autortt

## 🌐 Language / 语言 / Bahasa / Язык / 言語 / Ngôn ngữ / Dil / اللغة

[English](README.md) | [中文](README_zh.md) | [Bahasa Indonesia](README_id.md) | [Русский](README_ru.md) | [日本語](README_ja.md) | [Tiếng Việt](README_vi.md) | [Türkçe](README_tr.md) | **العربية**

---

**يضبط تلقائياً معامل RTT لـ CAKE qdisc بناءً على ظروف الشبكة المقاسة**

> [!NOTE]  
> إذا كنت تبحث عن **إصدار Ubuntu/Debian**، تحقق من مجلد `ubuntu-debian/`. ومع ذلك، لاحظ أن إصدار OpenWrt فقط يتم اختباره شخصياً يومياً - إصدار Ubuntu/Debian مقدم كما هو للمجتمع.

`cake-autortt` هي خدمة OpenWrt ذكية تراقب الاتصالات النشطة للشبكة وتضبط تلقائياً معامل RTT (Round Trip Time) لـ CAKE qdisc على واجهات الدخل والخرج للحصول على أداء شبكة مثالي.

## 🌍 لماذا هذا مهم لتجربة الإنترنت الخاصة بك

معظم المستخدمين معتادون على أوقات التحميل السريعة للمواقع الرئيسية مثل YouTube وNetflix وGoogle - هذه تستخدم شبكات توزيع المحتوى (CDNs) التي تضع خوادم قريبة جداً من المستخدمين، وعادة ما توفر أوقات استجابة أقل من 50-100ms. ومع ذلك، الإنترنت أوسع بكثير من هذه المنصات الكبيرة.

**عندما تتصفح الويب خارج المواقع الرئيسية المدعومة بـ CDN، تواجه عالماً متنوعاً من الخوادم:**
- **الخدمات المحلية/الإقليمية**: الشركات الصغيرة ومواقع الأخبار المحلية ومنتديات المجتمع والخدمات الإقليمية غالباً ما تحتوي على خوادم في بلدك أو منطقتك (10-50ms RTT)
- **المحتوى الدولي**: المواقع المتخصصة والموارد الأكاديمية وخوادم الألعاب والخدمات المتخصصة قد تكون مستضافة في قارات أخرى (100-500ms RTT)
- **البنية التحتية البعيدة**: بعض الخدمات، خاصة في المناطق النامية أو التطبيقات المتخصصة، قد تحتوي على زمن استجابة عالي بشكل كبير

**معامل CAKE RTT يتحكم في مدى عدوانية خوارزمية الطابور في الاستجابة للازدحام.** افتراضياً، CAKE يستخدم افتراض RTT 100ms، والذي يعمل بشكل جيد إلى حد ما لحركة الإنترنت العامة. ومع ذلك:

- **إعداد RTT منخفض جداً**: إذا اعتقد CAKE أن RTT للشبكة أقصر مما هو عليه فعلاً، يصبح عدوانياً جداً في إسقاط الحزم عند تشكيل الطابور، مما قد يقلل من عرض النطاق للخوادم البعيدة
- **إعداد RTT عالي جداً**: إذا اعتقد CAKE أن RTT للشبكة أطول مما هو عليه فعلاً، يصبح محافظاً جداً ويسمح بتكوين طوابير كبيرة، مما يخلق زمن استجابة غير ضروري للخوادم القريبة

**أمثلة على التأثير في العالم الحقيقي:**
- **مستخدم سنغافورة → خادم ألماني**: بدون ضبط RTT، مستخدم في سنغافورة يصل إلى موقع ألماني (≈180ms RTT) قد يواجه عرض نطاق مقلل بسبب إعداد CAKE الافتراضي 100ms الذي يسبب إسقاط حزم مبكر
- **ريف أمريكا → خادم إقليمي**: مستخدم في ريف أمريكا يصل إلى خادم إقليمي (≈25ms RTT) قد يواجه زمن استجابة أعلى من الضروري بسبب إعداد CAKE الافتراضي 100ms الذي يسمح للطوابير بالنمو أكبر من اللازم
- **تطبيقات الألعاب/الوقت الحقيقي**: التطبيقات الحساسة لكل من زمن الاستجابة وعرض النطاق تستفيد بشكل كبير من ضبط RTT المناسب لظروف الشبكة الفعلية

**كيف يساعد cake-autortt:**
بقياس RTT الفعلي للخوادم التي تتواصل معها تلقائياً وضبط معامل CAKE وفقاً لذلك، تحصل على:
- **استجابة أسرع** عند الوصول للخوادم القريبة (RTT أقصر → إدارة طابور أكثر عدوانية)
- **عرض نطاق أفضل** عند الوصول للخوادم البعيدة (RTT أطول → إدارة طابور أكثر صبراً)
- **تحكم مثالي في bufferbloat** يتكيف مع ظروف الشبكة الفعلية بدلاً من الافتراضات

هذا مفيد بشكل خاص للمستخدمين الذين يصلون بانتظام لمصادر محتوى متنوعة، أو يعملون مع خدمات دولية، أو يعيشون في مناطق حيث حركة الإنترنت تسافر عادة مسافات كبيرة.

## 🚀 الميزات

- **كشف RTT التلقائي**: يراقب الاتصالات النشطة عبر `/proc/net/nf_conntrack` ويقيس RTT للمضيفين الخارجيين
- **تصفية المضيفين الذكية**: يصفي تلقائياً عناوين LAN ويركز على المضيفين الخارجيين
- **خوارزمية RTT الذكية**: يستخدم ping المدمج لقياس كل مضيف بشكل فردي (3 pings لكل مضيف)، ثم يختار بذكاء بين متوسط RTT وأسوأ حالة للأداء الأمثل
- **كشف الواجهة التلقائي**: يكتشف تلقائياً الواجهات مع CAKE (يفضل `ifb-*` للتنزيل، الواجهات الفيزيائية للرفع)
- **تكامل خدمة OpenWrt**: يعمل كخدمة OpenWrt مناسبة مع بدء تشغيل تلقائي وإدارة العمليات
- **معاملات قابلة للتكوين**: جميع معاملات التوقيت والسلوك قابلة للتكوين عبر تكوين UCI
- **معالجة أخطاء قوية**: يتعامل بأناقة مع التبعيات المفقودة ومشاكل الشبكة وتغييرات الواجهة
- **تبعيات دنيا**: يتطلب فقط ping وtc - لا حاجة لحزم إضافية، يستخدم أدوات مدمجة متوفرة على جميع الأنظمة
- **RTT عالي الدقة**: يدعم قيم RTT كسرية (مثل 100.23ms) لتوقيت شبكة دقيق

## 🔧 التوافق

**تم اختباره ويعمل:**
- **OpenWrt 24.10.1, r28597-0425664679, منصة الهدف x86/64**

**التوافق المتوقع:**
- إصدارات OpenWrt السابقة (21.02+) مع دعم CAKE qdisc
- إصدارات OpenWrt المستقبلية طالما أن التبعيات المطلوبة متوفرة
- جميع معماريات الهدف المدعومة بواسطة OpenWrt (ARM, MIPS, x86, إلخ.)

**متطلبات التوافق:**
- وحدة kernel CAKE qdisc
- أداة ping (مضمنة في جميع توزيعات Linux القياسية)
- أداة tc القياسية (تحكم في حركة المرور)
- دعم /proc/net/nf_conntrack (netfilter conntrack)

## 📋 المتطلبات

### التبعيات
- **ping**: أداة ping القياسية لقياس RTT (مضمنة في جميع توزيعات Linux)
- **tc**: أداة تحكم حركة المرور (جزء من iproute2)
- **CAKE qdisc**: يجب أن يكون مكوناً على الواجهات المستهدفة

### تثبيت التبعيات

```bash
# ping مضمن افتراضياً في OpenWrt
# لا حاجة لحزم إضافية لوظيفة ping

# CAKE qdisc عادة متوفر في إصدارات OpenWrt الحديثة
# تحقق من دعم tc لـ CAKE:
tc qdisc help | grep cake
```

## 🔧 التثبيت

> [!IMPORTANT]  
> قبل تشغيل سكريبت التثبيت، يجب عليك تحرير ملف التكوين لتعيين أسماء الواجهات الصحيحة لنظامك.

1. **حرر ملف التكوين:**

```bash
# حرر ملف التكوين ليطابق أسماء واجهاتك
nano etc/config/cake-autortt
```

2. **كوّن أسماء واجهاتك:**

حدث إعدادات `dl_interface` (التنزيل) و`ul_interface` (الرفع) لتطابق إعداد شبكتك:

```bash
# أمثلة تكوين لإعدادات مختلفة:

# لإعداد OpenWrt SQM النموذجي باستخدام واجهات ifb:
option dl_interface 'ifb-wan'      # واجهة التنزيل (عادة ifb-*)
option ul_interface 'wan'          # واجهة الرفع (عادة wan, eth0, إلخ.)

# لإعداد واجهة مباشرة:
option dl_interface 'eth0'         # واجهة WAN الخاصة بك
option ul_interface 'eth0'         # نفس الواجهة لكلا الاتجاهين

# لأسماء واجهات مخصصة:
option dl_interface 'ifb4eth1'     # واجهة التنزيل المحددة الخاصة بك
option ul_interface 'eth1'         # واجهة الرفع المحددة الخاصة بك
```

**كيفية العثور على أسماء واجهاتك:**
```bash
# اسرد الواجهات مع CAKE qdisc
tc qdisc show | grep cake

# اسرد جميع واجهات الشبكة
ip link show

# تحقق من تكوين واجهة SQM (إذا كنت تستخدم SQM)
uci show sqm
```

### التثبيت السريع

1. **كوّن الواجهات (انظر القسم أعلاه)**

2. **شغّل سكريبت التثبيت:**

```bash
# اجعل سكريبت التثبيت قابلاً للتنفيذ وشغّله
chmod +x install.sh
./install.sh
```

### التثبيت اليدوي

1. **انسخ ملفات الخدمة إلى موجه OpenWrt الخاص بك:**

```bash
# انسخ الملف التنفيذي الرئيسي
cp usr/bin/cake-autortt /usr/bin/
chmod +x /usr/bin/cake-autortt

# انسخ سكريبت init
cp etc/init.d/cake-autortt /etc/init.d/
chmod +x /etc/init.d/cake-autortt

# انسخ ملف التكوين
cp etc/config/cake-autortt /etc/config/

# انسخ سكريبت hotplug
cp etc/hotplug.d/iface/99-cake-autortt /etc/hotplug.d/iface/
chmod +x /etc/hotplug.d/iface/99-cake-autortt
```

2. **فعّل وابدأ الخدمة:**

```bash
# فعّل الخدمة للبدء التلقائي عند الإقلاع
/etc/init.d/cake-autortt enable

# ابدأ الخدمة
/etc/init.d/cake-autortt start
```

## 🗑️ إلغاء التثبيت

لإزالة cake-autortt من نظامك:

```bash
# اجعل سكريبت إلغاء التثبيت قابلاً للتنفيذ وشغّله
chmod +x uninstall.sh
./uninstall.sh
```

سكريبت إلغاء التثبيت سوف:
- يوقف ويعطل الخدمة
- يزيل جميع الملفات المثبتة
- يزيل اختيارياً ملفات التكوين والنسخ الاحتياطية
- ينظف الملفات المؤقتة

## ⚙️ التكوين

### 🔧 تكوين الواجهة (مطلوب)

**أهم خطوة تكوين هي تعيين أسماء الواجهات الصحيحة.** الخدمة لن تعمل بشكل صحيح بدون أسماء الواجهات الصحيحة.

```bash
# عرض التكوين الحالي
uci show cake-autortt

# مطلوب: تعيين أسماء واجهاتك
uci set cake-autortt.global.dl_interface='your-download-interface'
uci set cake-autortt.global.ul_interface='your-upload-interface'
uci commit cake-autortt

# تغييرات تكوين اختيارية أخرى
uci set cake-autortt.global.rtt_update_interval='5'
uci set cake-autortt.global.debug='1'
uci commit cake-autortt

# أعد تشغيل الخدمة لتطبيق التغييرات
/etc/init.d/cake-autortt restart
```

الخدمة مكونة عبر UCI. حرر `/etc/config/cake-autortt` أو استخدم أوامر `uci`.

### معاملات التكوين

| المعامل | الافتراضي | الوصف |
|-----------|---------|-------------|
| `dl_interface` | auto | اسم واجهة التنزيل (مثل 'ifb-wan', 'ifb4eth1') |
| `ul_interface` | auto | اسم واجهة الرفع (مثل 'wan', 'eth1') |
| `rtt_update_interval` | 5 | الثواني بين تحديثات معامل qdisc RTT |
| `min_hosts` | 3 | الحد الأدنى لعدد المضيفين المطلوب لحساب RTT |
| `max_hosts` | 100 | الحد الأقصى لعدد المضيفين للفحص المتسلسل |
| `rtt_margin_percent` | 10 | هامش الأمان المضاف إلى RTT المقاس (نسبة مئوية) |
| `default_rtt_ms` | 100 | RTT الافتراضي عندما لا تتوفر مضيفين كافيين |
| `debug` | 0 | تفعيل سجل التصحيح (0=إيقاف, 1=تشغيل) |

> [!NOTE]  
> بينما معاملات الواجهة لها افتراضي "auto"، الكشف التلقائي قد لا يعمل بشكل موثوق في جميع التكوينات. يُنصح بشدة بتعيين هذه القيم صراحة.

> [!TIP]  
> للشبكات عالية النشاط (مثل حرم جامعي، شبكات عامة مع العديد من المستخدمين النشطين)، فكر في ضبط `rtt_update_interval` بناءً على خصائص شبكتك. الافتراضي 5 ثوانٍ يعمل بشكل جيد لمعظم الحالات، لكن يمكنك زيادته إلى 10-15 ثانية للشبكات الأكثر استقراراً أو تقليله إلى 3 ثوانٍ للبيئات الديناميكية جداً.

## 🔍 كيف يعمل

1. **مراقبة الاتصال**: يحلل دورياً `/proc/net/nf_conntrack` لتحديد اتصالات الشبكة النشطة
2. **تصفية المضيف**: يستخرج عناوين IP الوجهة ويصفي العناوين الخاصة/LAN
3. **قياس RTT**: يستخدم `ping` لقياس كل مضيف خارجي بشكل فردي (3 pings لكل مضيف)
4. **اختيار RTT الذكي**: يفحص المضيفين بشكل متسلسل لمنع ازدحام الشبكة، يحسب متوسط RTT وأسوأ حالة، ثم يستخدم القيمة الأعلى لضمان الأداء الأمثل لجميع الاتصالات
5. **هامش الأمان**: يضيف هامشاً قابلاً للتكوين إلى RTT المقاس لضمان تخزين مؤقت كافٍ
6. **تحديث qdisc**: يحدث معامل CAKE qdisc RTT على واجهات التنزيل والرفع

### 🧠 خوارزمية RTT الذكية

ابتداءً من الإصدار 1.2.0، cake-autortt ينفذ خوارزمية اختيار RTT ذكية بناءً على توصية Dave Täht (مؤلف مشارك لـ CAKE):

**المشكلة**: استخدام متوسط RTT فقط يمكن أن يكون مشكلة عندما تحتوي بعض المضيفين على زمن استجابة أعلى بشكل كبير من الآخرين. على سبيل المثال، إذا كان لديك 100 مضيف بمتوسط RTT 40ms، لكن 2 مضيف لديهما RTT 234ms و240ms، استخدام متوسط 40ms يمكن أن يسبب مشاكل أداء لهذه الاتصالات عالية الزمن.

**الحل**: الخوارزمية الحالية:
1. **تحسب كلاً من متوسط RTT وأسوأ حالة** من جميع المضيفين المستجيبين
2. **تقارن القيمتين** وتختار بذكاء القيمة المناسبة
3. **تستخدم أسوأ حالة RTT عندما تكون أعلى بشكل كبير** من المتوسط لضمان أداء جيد لجميع الاتصالات
4. **تستخدم متوسط RTT عندما تكون أسوأ حالة RTT قريبة** من المتوسط لتجنب الإعدادات المحافظة جداً

**لماذا هذا مهم**: وفقاً لـ [Dave Täht](https://forum.mikrotik.com/t/fq-codel-cake-stories/181067/17)، "من الأفضل، خاصة مع التشكيل الداخل، استخدام RTT النموذجي كتقدير للحصول على تحكم في الطابور قبل وصوله إلى مشكل ISP الذي تحاول التغلب عليه." ومع ذلك، إذا كان RTT الفعلي لأي مضيف أطول من RTT المعين على واجهة CAKE، يمكن أن يتأثر الأداء بشكل كبير.

**مثال من العالم الحقيقي**:
- 98 مضيف مع RTT 30-50ms (متوسط: 42ms)
- 2 مضيف مع RTT 200ms+ (أسوأ: 234ms)
- **الخوارزمية القديمة**: ستستخدم متوسط 45ms، مسببة مشاكل للمضيفين 200ms+
- **الخوارزمية الجديدة**: تستخدم أسوأ حالة RTT 234ms، مضمونة أداء مثالي لجميع الاتصالات

### مثال تدفق الاتصال

```
[جهاز LAN] → [موجه CAKE] → [الإنترنت]
                       ↑
                 cake-autortt يراقب
                 الاتصالات النشطة ويضبط
                 معامل RTT
```

## 📊 السلوك المتوقع

بعد التثبيت والبدء، يجب أن تلاحظ:

### التأثيرات الفورية
- الخدمة تبدأ تلقائياً وتبدأ مراقبة الاتصالات
- قياسات RTT تُسجل في سجل النظام (إذا كان التصحيح مفعلاً)
- معامل CAKE qdisc RTT يُحدث كل 5 ثوانٍ بناءً على ظروف الشبكة المقاسة
- قيم RTT عالية الدقة (مثل 44.89ms) تُطبق على CAKE qdisc

### الفوائد طويلة المدى
- **استجابة محسنة**: معامل RTT يُحدث مع ظروف الشبكة الفعلية
- **تحكم أفضل في Bufferbloat**: CAKE يمكنه اتخاذ قرارات إدارة طابور أكثر استنارة
- **أداء تكيفي**: يتكيف تلقائياً مع ظروف الشبكة المتغيرة (قمر صناعي، محمول، روابط مزدحمة)
- **دقة أعلى**: يأخذ عينات من حتى 100 مضيف (قابل للتكوين) لتمثيل أفضل لظروف الشبكة

### المراقبة

```bash
# تحقق من حالة الخدمة
/etc/init.d/cake-autortt status

# عرض سجلات الخدمة
logread | grep cake-autortt

# راقب معاملات CAKE qdisc
tc qdisc show | grep cake

# وضع التصحيح للسجلات المفصلة
uci set cake-autortt.global.debug='1'
uci commit cake-autortt
/etc/init.d/cake-autortt restart
```

## 🔧 استكشاف الأخطاء وإصلاحها

### المشاكل الشائعة

1. **الخدمة لا تبدأ**
   ```bash
   # تحقق من التبعيات
   which ping tc
   
   # تحقق من واجهات CAKE
   tc qdisc show | grep cake
   ```

2. **لا توجد تحديثات RTT**
   ```bash
   # فعّل وضع التصحيح
   uci set cake-autortt.global.debug='1'
   uci commit cake-autortt
   /etc/init.d/cake-autortt restart
   
   # تحقق من السجلات
   logread | grep cake-autortt
   ```

3. **فشل كشف الواجهة**
   ```bash
   # حدد الواجهات يدوياً
   uci set cake-autortt.global.dl_interface='ifb-wan'
   uci set cake-autortt.global.ul_interface='wan'
   uci commit cake-autortt
   /etc/init.d/cake-autortt restart
   ```

### معلومات التصحيح

مع تفعيل التصحيح (`uci set cake-autortt.global.debug='1'`)، الخدمة توفر سجلات مفصلة:

**مثال مخرجات التصحيح:**
```bash
[2025-01-09 18:34:22] cake-autortt DEBUG: استخراج المضيفين من conntrack
[2025-01-09 18:34:22] cake-autortt DEBUG: وُجد 35 مضيف غير LAN
[2025-01-09 18:34:22] cake-autortt DEBUG: قياس RTT بـ ping لـ 35 مضيف (3 pings لكل مضيف)
[2025-01-09 18:34:25] cake-autortt DEBUG: ملخص ping: 28/35 مضيف حي
[2025-01-09 18:34:25] cake-autortt DEBUG: استخدام متوسط RTT: 45.2ms (متوسط: 45.2ms، أسوأ: 89.1ms)
[2025-01-09 18:34:25] cake-autortt DEBUG: استخدام RTT المقاس: 45.2ms
[2025-01-09 18:34:35] cake-autortt INFO: تعيين CAKE RTT إلى 49.72ms (49720us)
[2025-01-09 18:34:35] cake-autortt DEBUG: RTT محدث على واجهة التنزيل ifb-wan
[2025-01-09 18:34:35] cake-autortt DEBUG: RTT محدث على واجهة الرفع wan
```

> [!NOTE]  
> **تسجيل فعال للذاكرة**: سجلات التصحيح محسنة لمنع فيض السجل. قياسات RTT للمضيفين الفرديين لا تُسجل لتقليل استخدام الذاكرة وكتابة القرص. فقط المعلومات الملخصة تُسجل، مما يجعلها مناسبة للتشغيل المستمر بدون نمو مفرط للسجل.

## 📄 الترخيص

هذا المشروع مرخص تحت GNU General Public License v2.0 - انظر ملف [LICENSE](LICENSE) للتفاصيل.

## 🤝 المساهمة

المساهمات مرحب بها! يرجى إرسال Pull Request.